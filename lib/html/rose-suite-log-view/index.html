<!--?xml version="1.0" encoding="utf-8"?-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
<style type="text/css">
@import "html-lib/DataTables/media/css/demo_table.css";
@import "html-lib/DataTables/extras/ColVis/media/css/ColVis.css";
.submit-fail {
    color: #ff007e;
    font-weight: bold;
    
}
.fail {
    color: red;
    font-weight: bold;
    
}
.pass {
    color: green;
    font-weight: bold;
}
#body-header {
    background: #060048;
    color: white;
    font-weight: bold;
    height: 2.5em;
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
}
#body-header a:link {
    color: #ffcb00;
}
#body-header a:visited,
#body-header a:hover,
#body-header a:active {
    color: #ffcb00;
}
#body-header h1 {
    font-size: x-large;
    margin: 0.1em;
    padding: 0;
}
#body-header p {
    float: right;
    font-size: small;
    margin: 0.2em;
    padding: 0;
}
#body-main {
    background: #eee;
    font-size: small;
    left: 0;
    margin: 0;
    padding: 0;
    padding-top: 0.1em;
    position: absolute;
    right: 0;
    top: 2.5em;
}
#body-main-top, #cycle_times_filter {
    background: white;
    border: thin solid #aaa;
    font-size: small;
    padding: 0.2em;
}
#body-main-top address {
    float: right;
    font-style: normal;
}
#body-main-top p {
    margin: 0;
    margin-left: 0.5em;
    padding: 0.1em;
}
table {
    border-collapse: collapse;
    clear: both;
    margin: 0;
    width: 100%
}
table,
td,
th {
    border: 1px solid #d0d0d0;
    white-space: nowrap;
}
td {
    border-bottom: 0;
    border-top: 0;
    padding: 0.3em;
    font-size: small;
}
th {
    font-size: small;
    padding: 0.3em;
    text-align: left;
}
#task_list_colvis * {
    margin: 0.1em;
}
#task_list_colvis button {
    padding: 0.1em;
}
#task_list_info {
    float: left;
    font-size: x-small;
    margin: 0.1em;
}
#task_list_filter {
    float: left;
    font-size: small;
    margin: 0.1em;
    margin-top: 0.4em;
    text-align: left;
}
.firstColumn {
    text-align: left;
}
.ex_highlight,
#task_list,
tbody,
tr.even:hover,
tr.even,
td.highlighted {
    background: #e3e3e3;
}
.ex_highlight,
#task_list,
tbody,
tr.odd:hover,
tr.odd,
td.highlighted {
    background: #e9e9e9;
}
tr.even {
    background: #f3f3f3;
}
tr.odd,
thead {
    background: white;
}
tr.odd td.sorting_1 {
    background: #e0e0e0;
}
tr.even td.sorting_1 {
    background: #f0f0f0;
}
.submit-num {
    float: right;
    font-weight: bold;
}
#cycle_time {
    height: 14.5em;
    position: relative;
}
#cycle_time div {
    left: 10.5em;
    position: absolute;
    top: 0.2em;
}
#cycle_time select {
    left: 0;
    height: 14em;
    position: absolute;
    top: 0.2em;
    width: 10em;
}
#cycle_time input[type=button], #cycle_time input[type=submit] {
    width: 9em;
}
</style>
<script type="text/javascript" src="html-lib/jquery/jquery.min.js">
</script>
<script type="text/javascript" src=
"html-lib/DataTables/media/js/jquery.dataTables.min.js">
</script>
<script type="text/javascript" src=
"html-lib/DataTables/extras/ColVis/media/js/ColVis.min.js">
</script>
<script type="text/javascript" charset="utf-8">
/* Plug-in: sort by delta-time in minutes:seconds format. */
jQuery.extend(jQuery.fn.dataTableExt.oSort, {
    "delta-time-m-s-pre": function(a) {
        if ($.trim(a) == "") {
            return 2147483647; // A big number
        }
        var m_and_s = a.split(":", 1);
        return (Number(m_and_s[0]) * 60 + Number(m_and_s[1]));
    },
 
    "delta-time-m-s-asc": function(a, b) {
        return a - b;
    },
 
    "delta-time-m-s-desc": function(a, b) {
        return b - a;
    }
});

/* The ready function */
$(function() {
    /* Report error loading a URL. */
    function err(url) {
        alert(url + ": could not load data.");
    }

    /* Get values of query parameter from URL matching key. */
    function get_opts(key, default_values) {
        var re_str = "[?&]" + key + "=([^&#]*)";
        var match = location.search.match(RegExp(re_str, "g"));
        if (match) {
            return $.map(match, function(m) {return RegExp(re_str).exec(m)[1]});
        }
        return default_values;
    };

    /* Convert a time delta in seconds to a M:SS string. */
    function timedelta2string(s) {
        if (s < 0) {
            return "0:00";
        }
        var minute = Math.floor(s / 60).toString();
        var second = Math.round(s % 60).toString();
        if (second.length == 1) {
            second = "0" + second;
        }
        return minute + ":" + second;
    }

    /* Convert a time in seconds since epoch to an object
     * containing the "date" string, the "time" string"
     * and the date + time "string". */
    function datetime2obj(s) {
        var d = new Date(s * 1000).toISOString();
        var dd = d.substr(0, d.indexOf("T"));
        var dt = d.substr(d.indexOf("T") + 1, 8);
        return {"date": dd, "time": dt, "string": dd + " " + dt};
    }

    /* Populate page with general suite data. */
    function populate_suite_data(data) {
        var title_var = data["suite"];
        document.title = title_var;
        $("h1:first").text(title_var).attr("title", data["suite"]);
        $("#body-header a[href^=\"source.html?path=\"]").each(function() {
            var href = $(this).attr("href") + "\&suite=" + data["suite"];
            $(this).attr("href", href);
        });
        $("#updated_at").text(datetime2obj(data["updated_at"])["string"]);
        for (var key in data["suite_info"]) {
            var p = $("<p/>").appendTo($("#suite_info"));
            p.append($("<dfn/>").text(key + ": "));
            p.append(data["suite_info"][key]);
        }
        $("#suite_info").hide();
        $("#suite_info_toggle").click(function() {
            $("#suite_info").toggle();
        });
        $.each(data["cycle_times_archived"], function(i, cycle_time) {
            $("#cycle_times_archived").append($("<option/>").text(cycle_time));
        });
        $.each(data["cycle_times_current"], function(i, cycle_time) {
            $("#cycle_times_current").append($("<option/>").text(cycle_time));
        });
        $("#cycle_times_select_current").click(function() {
            $("#cycle_times_current option").attr("selected", "selected");
            $("#cycle_times_archived option").removeAttr("selected");
        });
        $("#cycle_times_select_all").click(function() {
            $("#cycle_time select option").attr("selected", "selected");
        });
        $("#cycle_time_toggle").click(function() {
            $("#cycle_time").toggle();
        });
        $("#cycle_time_toggle").click();
        var t_cycle_times = 0;
        if (data["cycle_times_archived"]) {
            t_cycle_times += data["cycle_times_archived"].length;
        }
        if (data["cycle_times_current"]) {
            t_cycle_times += data["cycle_times_current"].length;
        }
        $("#t_cycle_times").text(t_cycle_times);
        populate_tasks_table();
    }

    /* Populate task table with data from a cycle. */
    function populate_cycle_tasks_data(data) {
        var cycle_time = data["cycle_time"];
        var cycle_time_archive = null;
        var opts_archived
            = $("#cycle_times_archived option:contains(" + cycle_time + ")");
        if (opts_archived.size() > 0) {
            cycle_time_archive = "job-" + cycle_time + ".tar.gz";
        }
        var option_node = $("#cycle_time option:contains(" + cycle_time + ")");
        option_node.attr("selected", "selected");
        var URL_PREFIX = "source.html?suite=" + data["suite"] + "\&path=";
        var node = $("#task_list");
        var task_keys = [];
        for (var task_name in data["tasks"]) {
            var submits = data["tasks"][task_name];
            $.each(submits, function(submit_num, submit_data) {
                var row = $("<tr/>").appendTo($("tbody", node));
                var cell;
                /* Column 1: task.cycle (submit-n) */
                cell = $("<td/>").appendTo(row).addClass("firstColumn")
                if (submits.length > 1) {
                    var span = $("<span/>").appendTo(cell);
                    span.addClass("submit-num");
                    span.text("(" + (submit_num + 1).toString() + ")");
                }
                var task_id_out = task_name + "." + cycle_time;
                cell.append(task_id_out);

                /* Column 2-3: name, cycle */
                cell = $("<td/>").appendTo(row).text(cycle_time);
                cell = $("<td/>").appendTo(row).text(task_name);

                /* Column 4: submit-n */
                cell = $("<td/>").appendTo(row);
                cell.append((submit_num + 1).toString());

                /* Column 5: status */
                cell = $("<td/>").appendTo(row);
                if (submit_data["status"] != null) {
                    var value = submit_data["status"];
                    var signal = submit_data["signal"];
                    if (signal && signal != "ERR") {
                        value += " (" + signal + ")";
                    }
                    cell.append(value);
                    cell.addClass(submit_data["status"]);
                }

                /* Column 6: submit time */
                var task_events = submit_data["events"];
                var date_submit = datetime2obj(task_events["submit"]);
                cell = $("<td/>").appendTo(row);
                cell.append(date_submit["string"]);

                /* Column 7: queue time delta */
                cell = $("<td/>").appendTo(row);
                if (task_events["init"] != null) {
                    var delta = task_events["init"] - task_events["submit"];
                    cell.append(timedelta2string(delta));
                }

                /* Column 8, 9: init time, exit time */
                $.each(["init", "exit"], function(i, key) {
                    cell = $("<td/>").appendTo(row);
                    if (task_events[key] != null) {
                        var str = task_events[key];
                        var obj = datetime2obj(task_events[key]);
                        /* Remove timestamp date if same as submit date */
                        if (obj["date"] == date_submit["date"]) {
                            str = obj["time"];
                        }
                        else {
                            str = obj["string"];
                        }
                        cell.append(str);
                    }
                });

                /* Column 10: run time delta */
                cell = $("<td/>").appendTo(row);
                if (    task_events["init"] != null
                    &&  task_events["exit"] != null
                ) {
                    var delta = task_events["exit"] - task_events["init"];
                    cell.append(timedelta2string(delta));
                }

                /* Column 11, 12, 13: stdout file, stderr file, job script */
                var task_files = submit_data["files"];
                $.each(["out", "err", "script"], function(i, name) {
                    cell = $("<td/>").appendTo(row);
                    if (task_files[name] != null) {
                        var file = "job/" + task_id_out + "."
                                 + (submit_num + 1);
                        if (name != "script") {
                            file += "." + name;
                        }
                        var content = "empty";
                        var n_bytes = task_files[name]["n_bytes"];
                        if (n_bytes > 0) {
                            if (cycle_time_archive) {
                                content = $("<a/>", {"href": cycle_time_archive});
                                content.append("archived");
                            }
                            else {
                                var file_uri = URL_PREFIX + file;
                                content = $("<a/>", {"href": file_uri});
                                content.append("view");
                            }
                            var n_bytes_str = n_bytes.toString();
                            content.attr("title", n_bytes_str + " byte(s)");
                        }
                        cell.append(content);
                    }
                });

                /* Column 14: other files */
                cell = $("<td/>").appendTo(row);
                var files = [];
                var indexed_files_data_map = {};
                for (var name in task_files) {
                    if (name in {"out": null, "err": null, "script": null}) {
                        continue;
                    }
                    var match = name.match(/^(.*)\.(\d+)(\.html)?$/);
                    if (match) {
                        var head = match[1];
                        if (head == null) {
                            head = "";
                        }
                        var idx = match[2];
                        var tail = match[3];
                        if (tail == null) {
                            tail = "";
                        }
                        var name = head + ".*" + tail;
                        if (!(name in indexed_files_data_map)) {
                            indexed_files_data_map[name] = {
                                "head": head,
                                "tail": tail,
                                "list": [],
                                "name": name};
                            files.push(name);
                        }
                        idx = Number(idx);
                        indexed_files_data_map[name]["list"].push(idx);
                    }
                    else {
                        files.push(name);
                    }
                }
                files.sort();
                for (var i = 0; i < files.length; i++) {
                    if (i > 0) {
                        cell.append(" | ");
                    }
                    var name = files[i];
                    if (name in indexed_files_data_map) {
                        if (indexed_files_data_map[name]["list"].length == 1) {
                            var d = indexed_files_data_map[name];
                            name = d["head"] + "." + d["list"][0] + d["tail"];
                            delete(indexed_files_data_map[name]);
                        }
                    }
                    var n = (submit_num + 1).toString();
                    var root = "job/" + task_id_out + "." + n + ".";
                    if (name in indexed_files_data_map) {
                        var d = indexed_files_data_map[name];
                        var select = $("<select/>").appendTo(cell);
                        var option = $("<option/>");
                        option.attr("selected", "selected");
                        option.attr("value", "");
                        option.text(name);
                        option.appendTo(select);
                        var list = d["list"];
                        list.sort(function(a, b) {return a - b});
                        for (var idx = 0; idx < list.length; idx++) {
                            var option = $("<option/>").appendTo(select);
                            var name_idx = list[idx].toString();
                            var name = d["head"] + "." + name_idx + d["tail"];
                            option.text(name);
                            option.click(function() {
                                var file = root + $(this).text();
                                if (cycle_time_archive) {
                                    location = cycle_time_archive;
                                }
                                else if (file.match(/\.html(?:\.\d+)?$/)) {
                                    location = file;
                                }
                                else {
                                    var file_uri = file;
                                    location = URL_PREFIX + file_uri;
                                }
                            });
                        }
                    }
                    else {
                        var n_bytes = task_files[name]["n_bytes"];
                        if (n_bytes == 0) {
                            var span = $("<span/>", {"title": "0 bytes"});
                            span.text(name);
                            cell.append(span);
                        }
                        else {
                            var n = submit_num + 1;
                            var file = root + name;
                            var anchor = $("<a/>");
                            var n_bytes_str = n_bytes.toString();
                            anchor.attr("title", n_bytes_str + " byte(s)");
                            if (cycle_time_archive) {
                                anchor.attr("href", cycle_time_archive);
                                anchor.text(name);
                            }
                            else if (name.match(/\.html$/)) {
                                anchor.attr("href", file);
                                anchor.text(name);
                            }
                            else {
                                var file_uri = file;
                                anchor.attr("href", URL_PREFIX + file_uri);
                                anchor.text(name);
                            }
                            cell.append(anchor);
                        }
                    }
                }
            });
        }
    }

    /* Populates the task table. */
    function populate_tasks_table(cycle_times) {
        if (cycle_times == null) {
            var default_values = [];
            $("#cycle_times_current option").each(function() {
                default_values.push($(this).text());
            });
            cycle_times = get_opts("cycle_time", default_values);
            $("#n_cycle_times").text(cycle_times.length);
        }
        if (cycle_times.length) {
            var cycle_time = cycle_times.shift();
            var url = "rose-suite-log-view-" + cycle_time + ".json";
            $.ajax({
                "url": url,
                "cache": false,
                "dataType": "json",
                "success": [
                    populate_cycle_tasks_data,
                    function() {populate_tasks_table(cycle_times);}
                ],
                "error": [
                    function() {err(url);},
                    function() {populate_tasks_table(cycle_times);}
                ]
            });
        }
        else {
            /* Table populated. Initialise Data Table. */
            var node = $("#task_list");
            node.dataTable({
                /* See columns of the task_list table */
                "aaSorting": [[5, "asc"]],
                "aoColumn": [
                    null,
                    {"bVisible": false},
                    {"bVisible": false},
                    {"bVisible": false, "sType": "numeric"},
                    null,
                    null,
                    {"sType": "delta-time-m-s"},
                    {"bVisible": false},
                    {"bVisible": false},
                    {"sType": "delta-time-m-s"},
                    null,
                    null,
                    {"bVisible": false},
                    null
                ],
                "bPaginate": false,
                "bStateSave": true,
                "oColVis": {"activate": "mouseover", "aiExclude": [0]},
                "oLanguage": {"sSearch": "Filter results:"},
                "sDom": '<"#task_list_colvis"C>frltip'
            });
        }
    }

    var url_main = "rose-suite-log-view.json";
    $.ajax({
        "url": url_main,
        "cache": false,
        "dataType": "json",
        "success": populate_suite_data,
        "error": [function() {err(url_main);}]
    });
} );
</script>
</head>

<body>
<div id="body-header">
<p>
  rose:
  <a href="source.html?path=rose-suite-run.version">suite-run version</a>
| <a href="source.html?path=rose-suite-run.conf">suite-run.conf</a>
| <a href="source.html?path=rose-suite-run.log">suite-run log</a>
| cylc:
  <a href="source.html?path=suite/log">suite log</a>
| <a href="source.html?path=suite/out">suite out</a>
| <a href="source.html?path=suite/err">suite err</a>
</p>

<h1>Output for suite</h1>
</div>

<div id="body-main">
<div id="body-main-top">
  <address>last updated: <span id="updated_at"></span></address>
  <div>
    <a id="suite_info_toggle" href="#">suite info</a>
    <div id="suite_info"></div>
  </div>
</div>
<div id="cycle_times_filter">
  <a id="cycle_time_toggle" href="#">cycle times filter</a>
  (<span id="n_cycle_times">?</span> of <span id="t_cycle_times">?</span>
  selected)
  <form id="cycle_time" action="#" method="get">
    <select name="cycle_time" multiple="multiple"
    title="filter cycle times">
      <optgroup id="cycle_times_current" label="current">
      </optgroup>
      <optgroup id="cycle_times_archived" label="archived">
      </optgroup>
    </select>
    <div>
    <input type="button" id="cycle_times_select_current"
    name="cycle_times_select_current" value="Select Current" />
    <br/>
    <input type="button" id="cycle_times_select_all"
    name="cycle_times_select_all" value="Select All" />
    <br/>
    <input type="submit" value="OK" />
    </div>
  </form>
</div>
<table id="task_list" summary="Task List">
  <thead>
    <tr>
      <th class="firstColumn">Job</th>
      <th>Cycle</th>
      <th>Name</th>
      <th>N<sub>submit</sub></th>
      <th>Status</th>
      <th>t<sub>submit</sub></th>
      <th>&Delta;t<sub>queue</sub></th>
      <th>t<sub>run</sub></th>
      <th>t<sub>exit</sub></th>
      <th>&Delta;t<sub>run</sub></th>
      <th>Out</th>
      <th>Err</th>
      <th>Script</th>
      <th>Other Files</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>
</body>
</html>
