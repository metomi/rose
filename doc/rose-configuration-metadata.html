<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Rose Reference Guide: Configuration Metadata</title>
  <meta name="author" content="Rose Team, Met Office, UK" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="icon" href="rose-icon.png" type="image/png" />
  <link rel="shortcut icon" href="rose-icon.png" type="image/png" />
  <link rel="stylesheet" type="text/css" href="rose-doc.css" />
  <link rel="stylesheet" type="text/css" href=
  "google-code-prettify/prettify.css" />
  <script type="text/javascript" src="jquery.min.js">
</script>
  <script type="text/javascript" src="google-code-prettify/prettify.js">
</script>
  <script type="text/javascript" src="prettify-rose-conf.js">
</script>
  <script type="text/javascript" src="rose-doc.js">
</script>
  <script type="text/javascript" src="rose-version.js">
</script>
</head>

<body>
  <div class="header-footer" id="body-header">
    <address>
      &copy; British Crown Copyright 2012-3 <a href=
      "http://www.metoffice.gov.uk">Met Office</a>. See <a href=
      "rose-terms-of-use.html">Terms of Use</a>.<br />
      This document is released under the <a href=
      "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
      "license">Open Government Licence</a>.<br />
      <span id="rose-version"></span>
    </address><img id="rose-icon" src="rose-icon.png" alt="Rose" />

    <p><a href=".">Rose Documentation</a></p>
  </div>

  <div id="body-main">
    <h1>Rose Reference Guide: Configuration Metadata</h1>

    <div id="content"></div>

    <h2 id="format-location">Format and Location</h2>

    <p>See <a href="rose-configuration.html#format">Configuration
    Format</a>.</p>

    <p>A configuration metadata is itself a configuration. Each configuration
    metadata is represented in a directory with the following:</p>

    <ul>
      <li><samp>rose-meta.conf</samp>, the main configuration file. See
      <a href="#meta.conf"></a> for detail.</li>

      <li><samp>opt/</samp> directory. For detail, see <a href=
      "rose-configuration.html#opts">Optional Configuration</a>.</li>

      <li>other files, e.g.:

        <ul>
          <li><samp>lib/python/widget/my_widget.py</samp> would be the location
          of a custom widget.</li>

          <li><samp>lib/python/macros/my_macro_validator.py</samp> would be the
          location of a custom macro.</li>

          <li><samp>etc/</samp> would contain any resources for the logics in
          <samp>lib/python/</samp>, such as an icon for the custom widget.</li>
        </ul>
      </li>
    </ul>

    <p>Rose utilities will do a path search for metadata using the following in
    order of precedence:</p>

    <ul>
      <li>Configuration metadata embedded in the <samp>meta/</samp> directory
      of a suite or an application.</li>

      <li>The <code>--meta-path=PATH</code> option of relevant commands.</li>

      <li>The value of the <var>ROSE_META_PATH</var> environment variable.</li>

      <li>The <samp>meta-path</samp> setting in <a href=
      "rose-configuration.html#site">site/user</a> configurations.</li>
    </ul>

    <p>See <a href="#appendix-metadata-location">Metadata Location</a> for more
    details.</p>

    <p>The configuration metadata that controls default behaviour will be
    located in <samp>$ROSE_HOME/etc/rose-meta/</samp>.</p>

    <h2 id="meta.conf">Configuration Metadata File</h2>

    <p>The <samp>rose-meta.conf</samp> contains a serialised data structure
    that is an unordered map (sections=) of unordered maps (keys=values).</p>

    <p>The section name in a configuration metadata file should be a unique ID
    to the relevant configuration setting. The syntax of the ID is
    <code>SECTION-NAME=OPTION-NAME</code> or just <code>SECTION-NAME</code>.
    For example, <samp>env=MY_ENV_NAME</samp> is the ID of an environment
    variable called <var>MY_ENV_NAME</var> in an application configuration
    file; <samp>namelist:something_nl=variable_name1</samp> is the ID of a
    namelist variable called <var>variable_name1</var> in a namelist group
    called <var>something_nl</var> in an application configuration file. If the
    configuration metadata applies to a section in a configuration file, the ID
    is just the section name.</p>

    <p>Where multiple instances of a section are used in a configuration file,
    ending in brackets with numbers, the metadata id should just be based on
    the original section name (for example
    <samp>namelist:extract_control(2)</samp> should be found in the metadata
    under <samp>namelist:extract_control</samp>).</p>

    <p>Finally, the configuration metadata may group settings in namespaces,
    which may in turn have common configuration metadata settings. The ID for a
    namespace set in the metadata is <code>ns=NAME</code>, e.g.
    <samp>ns=env/MyFavouriteEnvironmentVars</samp>.</p>

    <p>The metadata for a configuration fall into 4 categories: sorting,
    values, behaviour and help. They are be described separated below:</p>

    <h3 id="meta.conf.sorting">Metadata for Sorting</h3>

    <p>These configuration metadata are used for grouping and sorting the IDs
    of the configurations.</p>

    <dl>
      <dt id="meta.conf.sorting.ns">ns</dt>

      <dd>
        <p>A forward slash <kbd>/</kbd> delimited hierarchical namespace for
        the container of the setting, which overrides the default. The default
        namespace for the setting is derived from the first part of the ID - by
        splitting up the section name by colons <kbd>:</kbd> or forward slashes
        <kbd>/</kbd>. For example, a configuration with an ID
        <samp>namelist:var_minimise=niter_set</samp> would have the namespace
        <samp>namelist/var_minimise</samp>. If a namespace is defined for a
        section, it will become the default for all the settings in that
        section.</p>

        <p>The namespace is used by the config editor to group settings, so
        that they can be placed in different pages. A namespace for a section
        will become the default for all the settings in that section.</p>
      </dd>

      <dt id="meta.conf.sorting.sort-key">sort-key</dt>

      <dd>
        <p>A character string that can be used as a sort key for ordering an
        option within its namespace.</p>

        <p>It can also be used to order sections and namespaces.</p>

        <p>The sort-key is used by the config editor to group settings on a
        page. Items with a sort-key will be sorted to the top of a name-space.
        Items without a sort-key will be sorted after, in ascending order of
        their IDs.</p>

        <p>The sorting procedure in pseudo code is a normal ASCII-like sorting
        of a list of <samp>setting_sort_key + "~" + setting_id</samp> strings.
        If there is no <samp>setting_sort_key</samp>, null string will be
        used.</p>

        <p>For example, the following metadata:</p>
        <pre class="prettyprint lang-rose_conf">
[env=apple]

[env=banana]

[env=cherry]
sort-key=favourites-01

[env=melon]
sort-key=do-not-like-01

[env=prune]
sort-key=do-not-like-00
</pre>

        <p>would produce a sorting order of <samp>env=prune</samp>,
        <samp>env=melon</samp>, <samp>env=cherry</samp>,
        <samp>env=apple</samp>, <samp>env=banana</samp>.</p>
      </dd>
    </dl>

    <h3 id="meta.conf.value">Metadata for Values</h3>

    <p>These configuration metadata are used to define the valid values of a
    setting. A Rose utility such as the config editor can use these metadata to
    display the correct widget for a setting and to check its input. However,
    if the value of a setting contains a string that looks like an environment
    variable, these metadata will normally be ignored.</p>

    <dl>
      <dt id="meta.conf.value.type">type</dt>

      <dd>
        <p>The type/class of the setting. The type names are based on the
        intrinsic Fortran types, such as <code>integer</code> and
        <code>real</code>. Currently supported types are:</p>

        <dl>
          <dt><code>boolean</code></dt>

          <dd>
            <p><dfn>example option:</dfn> <samp>PRODUCE_THINGS=true</samp></p>

            <p><dfn>description:</dfn> either <samp>true</samp> or
            <samp>false</samp></p>

            <p><dfn>usage:</dfn> environment variables, javascript/JSON
            inputs</p>
          </dd>

          <dt><code>character</code></dt>

          <dd>
            <p><dfn>example option:</dfn> <samp>sea_colour='blue'</samp></p>

            <p><dfn>description:</dfn> Fortran character type - a single quoted
            string, single quotes escaped in pairs</p>

            <p><dfn>usage:</dfn> Fortran character types</p>
          </dd>

          <dt><code>integer</code></dt>

          <dd>
            <p><dfn>example option:</dfn> <samp>num_lucky=5</samp></p>

            <p><dfn>description:</dfn> generic integer type</p>

            <p><dfn>usage:</dfn> any integer-type input</p>
          </dd>

          <dt><code>logical</code></dt>

          <dd>
            <p><dfn>example option:</dfn> <samp>l_spock=.true.</samp></p>

            <p><dfn>description:</dfn> Fortran logical type - either
            <samp>.true.</samp> or <samp>.false.</samp></p>

            <p><dfn>usage:</dfn> Fortran logical types</p>
          </dd>

          <dt><code>quoted</code></dt>

          <dd>
            <p><dfn>example option:</dfn>
            <samp>js_measure_cloud_mode="laser"</samp></p>

            <p><dfn>description:</dfn> a double quoted string, double quotes
            escaped with backslash</p>

            <p><dfn>usage:</dfn> Inputs that require double quotes and allow
            backslash escaping e.g. javascript/JSON inputs.</p>
          </dd>

          <dt><code>real</code></dt>

          <dd>
            <p><dfn>example option:</dfn> <samp>n_avogadro=6.02e23</samp></p>

            <p><dfn>description:</dfn> Fortran real number type, generic
            floating point numbers</p>

            <p><dfn>usage:</dfn> Fortran real types, generic floating point
            numbers. Scientific notation must use the "e" or "E" format.</p>

            <p><dfn>comment:</dfn> Internally implemented within Rose using
            Python's <a href=
            "http://docs.python.org/library/stdtypes.html#typesnumeric">floating
            point</a> specification.</p>
          </dd>

          <dt><code>raw</code></dt>

          <dd>
            <p><dfn>description:</dfn> placeholder used in derived type
            specifications where none of the above types apply</p>

            <p><dfn>usage:</dfn> only in derived types</p>
          </dd>
        </dl>

        <p>Note that not all inputs need to have <code>type</code> defined. In
        some cases using <a href=
        "#meta.conf.value.values"><code>values</code></a> or <a href=
        "#meta.conf.value.values"><code>pattern</code></a> is better.</p>

        <p>A derived type may be defined by a comma <kbd>,</kbd> separated list
        of intrinsic types, e.g. <samp>integer, character, real,
        integer</samp>. The default is a raw string.</p>
      </dd>

      <dt id="meta.conf.value.length">length</dt>

      <dd>
        <p>Define the length of an array. If not present, the setting is
        assumed to be a scalar. A positive integer defines a fixed length
        array. A colon <kbd>:</kbd> defines a dynamic length array.</p>
      </dd>

      <dt id="meta.conf.value.values">values</dt>

      <dd>
        <p>Define a comma <kbd>,</kbd> separated list of permitted values of a
        setting (or an element in the setting if it is an array). This metadata
        overrides the <a href="#meta.conf.value.type"><code>type</code></a>,
        <a href="#meta.conf.value.range"><code>range</code></a> and <a href=
        "#meta.conf.value.pattern"><code>pattern</code></a> metadata.</p>

        <p>For example, the config editor may use this list to determine the
        widget to display the setting. It may display the choices using a set
        of radio buttons if the list of values is small, or a drop down combon
        box if the list of values is large. If the list only contains one
        value, the config editor will expect the setting to always have this
        value, and may display it as a special setting.</p>
      </dd>

      <dt id="meta.conf.value.value-titles">value-titles</dt>

      <dd>
        <p>Define a comma <kbd>,</kbd> separated list of titles to associate
        with each of the elements of <a href=
        "#meta.conf.value.values"><code>values</code></a> which will be
        displayed instead of the value. This list should contain the same
        number of elements as the <code>values</code> entry.</p>

        <p>For example, given the following metadata:</p>
        <pre class="prettyprint lang-rose_conf">
[env=HEAT]
values=0, 1, 2
value-titles=low, medium, high
</pre>

        <p>the config editor will display <samp>low</samp> for option value
        <samp>0</samp>, <samp>medium</samp> for <samp>1</samp> and
        <samp>high</samp> for <samp>2</samp>.</p>
      </dd>

      <dt id="meta.conf.value.range">range</dt>

      <dd>
        <p>Specify a range of values. It can either be a simple comma
        <kbd>,</kbd> separated list of allowed values, or a logical expression
        in the Rose metadata <a href=
        "#appendix-mini-language">mini-language</a>. This metadata is only
        valid if <a href="#meta.conf.value.type"><code>type</code></a> is
        either <samp>integer</samp> or <samp>real</samp>.</p>

        <p>A simple list may contain a mixture of allowed numbers and number
        ranges such as <samp>1, 2, 4:8, 10:</samp>, (which means the value can
        be 1, 2, between 4 and 8 inclusive, or any values greater than or equal
        to 10.)</p>

        <p>A logical expression uses the Rose metadata <a href=
        "#appendix-mini-language">mini-language</a>, using the variable
        <var>this</var> to denote the value of the current setting, e.g.
        <samp>this &lt;-1 and this &gt;1</samp>. Inter-variable comparisons are
        not permitted (but see the <a href=
        "#meta.conf.value.fail-if"><code>fail-if</code></a> property below for
        a way to implement this).</p>
      </dd>

      <dt id="meta.conf.value.pattern">pattern</dt>

      <dd>
        <p>Specify a regular expression (Python's extended regular expression
        syntax) that the value of the setting must match.</p>
      </dd>

      <dt id="meta.conf.value.fail-if">fail-if, warn-if</dt>

      <dd>
        <p>Specify a logical expression using the Rose <a href=
        "#appendix-mini-language">mini-language</a> to validate the value of
        the current setting with respect to other settings. If the logical
        expression evaluates to true in a <code>fail-if</code> metadata, the
        system will consider the setting in error. On the other hand, in a
        <code>warn-if</code> metadata, the system will only issue a warning.
        The logical expression uses a Python-like syntax (documented fully in
        the <a href="#appendix-mini-language">appendix</a>). It can reference
        the value of the current setting with the <var>this</var> variable and
        the value of other settings with their IDs. E.g.:</p>
        <pre class="prettyprint lang-rose_conf">
[namelist:test=my_test_var]
fail-if=this &lt; namelist:test=control_lt_var;
</pre>

        <p>means that an error will be flagged if the numeric value of
        <var>my_test_var</var> is less than the numeric value of
        <var>control_lt_var</var>.</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=this != 1 + namelist:test=ctrl_var_1 * (namelist:test=ctrl_var_2 - this);
</pre>

        <p>shows a more complex operation, again with numeric values.</p>

        <p>To check array elements, the ID should be expressed with a bracketed
        index, as in the configuration:</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=this(2) != "'0A'" and this(4) == "'0A'";
</pre>

        <p>Array elements can also be checked using <code>any</code> and
        <code>all</code>. E.g.:</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=any(namelist:test=ctrl_array &lt; this);
fail-if=all(this == 0);
</pre>

        <p>Expressions can be chained together and brackets used:</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=this(4) == "'0A'" and (namelist:test=ctrl_var_1 != "'N'" or namelist:test=ctrl_var_2 != "'Y'" or all(namelist:test=ctrl_arr_3 == 'N'));
</pre>

        <p>Multiple failure conditions can be added, by using a semicolon as
        the separator - the semicolon is optional for a single statement or the
        last in a block, but is recommended. Multiple failure conditions are
        essentially similar to chaining them together with <code>or</code>, but
        the system can process each expression one by one to target the error
        message.</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=this &gt; 0; this % 2 == 1; this * 3 &gt; 100;
</pre>

        <p>You can add a message to the error or warning message to make it
        clearer by adding a hash followed by the comment at the end of a
        configuration metadata line:</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=any(namelist:test=ctrl_array % this == 0); # Needs to be common divisor for ctrl_array
</pre>

        <p>When using multiple failure conditions, different messages can be
        added if they are placed on individual lines:</p>
        <pre class="prettyprint lang-rose_conf">
fail-if=this &gt; 0; # Needs to be less than or equal to 0
        this % 2 == 1; # Needs to be odd
        this * 3 &gt; 100; # Needs to be more than 100/3.
</pre>

        <p>A slightly different usage of this functionality can do things like
        warn of deprecated content:</p>
        <pre class="prettyprint lang-rose_conf">
warn-if=True;  # This option is deprecated
</pre>

        <p>This would always evaluate True and give a warning if the setting is
        present.</p>

        <p>Please note: when dividing a real-numbered setting by something,
        make sure that the expression does not actually divide an integer by an
        integer - for example, <samp>this / 2</samp> will evaluate as
        <samp>0</samp> if <var>this</var> has a value of <samp>1</samp>, but
        <samp>0.5</samp> if it has a value of <samp>1.0</samp>. This is a
        result of Python's implicit typing.</p>

        <p>You can get around this by making sure either the numerator or
        denominator is a real number - e.g. by rewriting it as <samp>this /
        2.0</samp> or <samp>1.0 * this / 2</samp>.</p>
      </dd>
    </dl>

    <h3 id="meta.conf.behaviour">Metadata for Behaviour</h3>

    <p>These metadata are used to define how the setting should behave in
    different states.</p>

    <dl>
      <dt id="meta.conf.behaviour.compulsory">compulsory</dt>

      <dd>
        <p>A <kbd>true</kbd> value indicates that the setting should be
        compulsory. If this flag is not set, the setting is optional.</p>

        <p>Compulsory settings should be physically present in the
        configuration at all times. Optional settings can be removed as the
        user wishes. Compulsory settings may however be triggered ignored (see
        below). For example, the config editor may issue a warning if a
        compulsory setting is not defined. It may also hide a compulsory
        variable that only has a single permitted value.</p>
      </dd>

      <dt id="meta.conf.behaviour.trigger">trigger</dt>

      <dd>
        <p>A setting has the following states:</p>

        <ul>
          <li>normal</li>

          <li>user ignored (stored in the configuration file with a
          <kbd>!</kbd> flag, ignored at run time)</li>

          <li>logically ignored (stored in the configuration file with a
          <kbd>!!</kbd> flag, ignored at runtime)</li>
        </ul>

        <p>If a setting is user ignored, the trigger will do nothing.
        Otherwise:</p>

        <ul>
          <li>If the logic for a setting in the trigger is fulfilled, it will
          cause the setting to be enabled.</li>

          <li>If it is not, it will cause the setting to be logically
          ignored.</li>
        </ul>

        <p>The trigger expression is a list of settings triggered by (different
        values of) this setting. If the values are not given, the setting will
        be triggered only if the current setting is enabled.</p>

        <p>The syntax contains id-values pairs, where the values part is
        optional. Each pair must be separated by a semi-colon. Within each
        pair, any values must be separated from the id by a colon and a space
        (<samp>:</samp> ). Values must be formatted in the same way as the
        setting "values" defined above (i.e. comma separated).</p>

        <p>The trigger syntax looks like:</p>
        <pre class="prettyprint lang-rose_conf">
[namelist:trig_nl=trigger_variable]
trigger=namelist:dep_nl=A;
        namelist:dep_nl=B;
        namelist:value_nl=X: 10;
        env=Y: 20, 30, 40;
        namelist:value_nl=Z: 20;
</pre>

        <p>In this example:</p>

        <ul>
          <li>When <var>namelist:trig_nl=trigger_variable</var> is ignored, all
          the variables in the trigger expression will be ignored, irrespective
          of its value.</li>

          <li>When <var>namelist:trig_nl=trigger_variable</var> is enabled,
          <var>namelist:dep_nl=A</var> and <var>namelist:dep_nl=B</var> will
          both be enabled, and the other variables <em>may</em> be enabled
          according to its value:

            <ul>
              <li>When the value of the setting is not <samp>10</samp>,
              <samp>20</samp>, <samp>30</samp>, or <samp>40</samp>,
              <var>namelist:value_nl=X</var>, <var>env=Y</var> and
              <var>namelist:value_nl=Z</var> will be ignored.</li>

              <li>When the value of the setting is <samp>10</samp>,
              <var>namelist:value_nl=X</var> will be enabled, but
              <var>env=Y</var> and <var>namelist:value_nl=Z</var> will be
              ignored.</li>

              <li>When the value of the setting is <samp>20</samp>,
              <var>env=Y</var> and <var>namelist:value_nl=Z</var> will be
              enabled, but <var>namelist:value_nl=X</var> will be ignored.</li>

              <li>When the value of the setting is <samp>30</samp>,
              <var>env=Y</var> will be enabled, but
              <var>namelist:value_nl=X</var> and <var>namelist:value_nl=Z</var>
              will be ignored.</li>

              <li>If the value of the setting contains an environment
              variable-like string, e.g. <samp>${TEN_MULTIPLE}</samp>, all
              three will be enabled.</li>
            </ul>
          </li>
        </ul>

        <p>Settings mentioned in trigger expressions will have their default
        state set to ignored unless explicitly triggered. The config editor
        will issue warnings if variables or sections are in the incorrect state
        when it loads a configuration. Triggering thereafter will work as
        normal.</p>

        <p>Where multiple triggers act on a setting, the setting is triggered
        only if all triggers are active (i.e. an <em>AND</em> relationship).
        For example, for the two triggers here:</p>
        <pre class="prettyprint lang-rose_conf">
[env=IS_WATER]
trigger=env=IS_ICE: true;

[env=IS_COLD]
trigger=env=IS_ICE: true;
</pre>

        <p>the setting <var>env=IS_ICE</var> is only enabled if both
        <var>env=IS_WATER</var> and <var>env=IS_COLD</var> are
        <samp>true</samp> and enabled. Otherwise, it is ignored.</p>

        <p>The trigger syntax also supports a logical expression using the Rose
        metadata <a href="#appendix-mini-language">mini-language</a>, in the
        same way as the <a href="#meta.conf.value.range"><code>range</code></a>
        or <a href="#meta.conf.value.fail-if"><code>fail-if</code></a>
        metadata. As with <code>range</code>, inter-variable comparisons are
        disallowed.</p>
        <pre class="prettyprint lang-rose_conf">
[env=SNOWFLAKE_SIDES]
trigger=env=CUSTOM_SNOWFLAKE_GEOMETRY: this != 6;
        env=SILLY_SNOWFLAKE_GEOMETRY: this &lt; 2;
</pre>

        <p>In this example, the setting
        <var>env=CUSTOM_SNOWFLAKE_GEOMETRY</var> is enabled if
        <var>env=SNOWFLAKE_SIDES</var> is enabled and not <samp>6</samp>.
        <var>env=SILLY_SNOWFLAKE_GEOMETRY</var> is only enabled when
        <var>env=SNOWFLAKE_SIDES</var> is enabled and less than <samp>2</samp>.
        The logical expression syntax can be used with non-numeric variables in
        the same way as the fail-if metadata.</p>
      </dd>

      <dt>duplicate</dt>

      <dd>
        <p>Allow duplicated copies of the setting. This is used for sections
        where there may be more than one with the same metadata - for example
        multiple namelist groups of the same name. If this setting is true for
        a given name, the application configuration will accept multiple
        namelist groups of this name. The config editor may then provide the
        option to clone or copy a namelist to generate an additional namelist.
        Otherwise, the config editor may issue warning for configuration
        sections that are found with multiple copies or an index.</p>
      </dd>

      <dt id="meta.conf.behaviour.macro">macro</dt>

      <dd>
        <p>Associate a setting with a comma-delimited set of custom macros (but
        not upgrade macros).</p>

        <p>E.g. for a macro class called <samp>FibonacciChecker</samp> in the
        metadata under <samp>lib/python/macros/fib.py</samp>, we may have:</p>
        <pre class="prettyprint lang-rose_conf">
macro=fib.FibonacciChecker
</pre>

        <p>This may be used in the config editor to visually associate the
        setting with these macros. If a macro class has both a
        <code>transform</code> and a <code>validate</code> method, you can
        specify which you need by appending the method to the name e.g.:</p>
        <pre class="prettyprint lang-rose_conf">
macro=fib.Fibonacci.validate
</pre>
      </dd>

      <dt id="meta.conf.behaviour.widget">widget[gui-application]</dt>

      <dd>
        <p>Indicate that the gui-application (e.g. config-edit) should use a
        special widget to display this setting.</p>

        <p>E.g. If we want to use a slider instead of an entry box for a
        floating point real number.</p>

        <p>The widget may take space-delimited arguments which would be
        specified after the widget name. E.g. to set up a hypothetical table
        with named columns X, Y, VCT, and Level, we may do:</p>
        <pre class="prettyprint lang-rose_conf">
widget[rose-config-edit]=table X Y VCT Level
</pre>

        <p>You may override to a Rose built-in widget by specifying a full
        <code>rose</code> class path in Python - for example, to always show
        radiobuttons for an option with <a href=
        "#meta.conf.value.values"><code>values</code></a> set:</p>
        <pre class="prettyprint lang-rose_conf">
widget[rose-config-edit]=rose.config_editor.valuewidget.radiobuttons
</pre>
      </dd>
    </dl>

    <h3 id="meta.conf.help">Metadata for Help</h3>

    <p>These metadata provide help for a configuration.</p>

    <dl>
      <dt id="meta.conf.help.url">url</dt>

      <dd>
        <p>A web URL containing help for the setting. For example:</p>
        <pre class="prettyprint lang-rose_conf">
url=http://www-nwp/~frve/VER/view/dev/doc/GTDP5.html
</pre>

        <p>For example, the config editor will trigger a web browser to display
        this when a variable name is clicked.</p>
      </dd>

      <dt id="meta.conf.help.help">help</dt>

      <dd>
        <p>(Long) help for the setting. For example, the config editor will use
        this in a popup dialog for a variable. Embedding variable ids in the
        help string will allow links to the variables to be created within the
        popup dialog box, e.g.</p>
        <pre class="prettyprint lang-rose_conf">
help=Used in conjunction with namelist:Var_DiagnosticsNL=n_linear_adj_test to
 do something linear.
</pre>

        <p>Web URLs beginning with <samp>http://</samp> will also be presented
        as links in the config editor.</p>
      </dd>

      <dt id="meta.conf.help.description">description</dt>

      <dd>
        <p>(Medium) description for the setting. For example, the configuration
        editor will use this as part of the hover over text.</p>

        <p>The config editor will also use descriptions set for sections or
        namespaces as page header text (appears at the top of a panel or page),
        with clickable id and URL links as in help. Descriptions set for
        variables may be automatically shown underneath the variable name in
        the config editor, depending on view options.</p>
      </dd>

      <dt id="meta.conf.help.title">title</dt>

      <dd>
        <p>(Short) title for the setting. For example, the config editor can
        use this specification as the label of a setting, instead of the
        variable name.</p>
      </dd>
    </dl>

    <h2 id="appendix-metadata-location">Appendix: Metadata Location</h2>

    <p>Centralised Rose metadata is referred to with either the <var>meta</var>
    or <var>project</var> top level flag in a configuration. It needs to live
    in a system-global-readable location.</p>

    <p>Rose utilities will do a path search for metadata using the following in
    order of precedence:</p>

    <ul>
      <li>The <code>--meta-path=PATH</code> option of relevant commands.</li>

      <li>The content of the <var>ROSE_META_PATH</var> environment
      variable.</li>

      <li>The <samp>meta-path</samp> setting in <a href="#site">site/user</a>
      configurations.</li>
    </ul>

    <p>Each of the above settings can be a colon-separated list of paths.</p>

    <p>Underneath each directory in the search path should be a hierarchy like
    the following:</p>
    <pre class="prettyprint lang-rose_conf">
${APP}/HEAD/
${APP}/${VERSION}/
${APP}/versions.py # i.e. the upgrade macros
</pre>

    <p>N.B. A Rose suite info is likely to have no versions.</p>

    <p>Note that, in some cases, a number of different executables may share
    the same application configuration metadata in which case APP is given a
    name which covers all the uses.</p>

    <p>The Rose team recommend placing metadata in a <samp>rose-meta</samp>
    directory at the top of a project's source tree. Central metadata, if any,
    at the <samp>meta-path</samp> location in the site configuration, should be
    a collection of regularly-updated subdirectories from all of the relevant
    projects' <samp>rose-meta</samp> directories.</p>

    <p>For example, for a system <code>COFFEE</code>, with the following
    directory structure:</p>
    <pre class="prettyprint lang-rose_conf">
COFFEE/doc/
...
COFFEE/rose-meta/
COFFEE/rose-meta/coffee-cappuccino/
COFFEE/rose-meta/coffee-latte/
COFFEE/rose-meta/coffee-mocha/
</pre>

    <p>and the system <code>CHOCOLATE</code>:</p>
    <pre class="prettyprint lang-rose_conf">
CHOCOLATE/doc/
...
CHOCOLATE/rose-meta/
CHOCOLATE/rose-meta/choc-dark/
CHOCOLATE/rose-meta/choc-milk/
</pre>

    <p>and a site configuration with:</p>
    <pre class="prettyprint lang-rose_conf">
meta-path=/path/to/rose-meta
</pre>

    <p>We would expect the following directories in
    <samp>/path/to/rose-meta</samp>:</p>
    <pre class="prettyprint lang-rose_conf">
/path/to/rose-meta/coffee-cappuccino/
/path/to/rose-meta/coffee-latte/
/path/to/rose-meta/coffee-mocha/
/path/to/rose-meta/choc-dark/
/path/to/rose-meta/choc-milk/
</pre>

    <h2 id="appendix-upgrade">Appendix: Upgrade and Versions</h2>

    <p>Terminology:</p>

    <dl>
      <dt>The HEAD (i.e. development) version</dt>

      <dd>The configuration metadata most relevant to the latest revision of
      the source tree.</dd>

      <dt>A named version</dt>

      <dd>The configuration metadata most relevant to a release, or a
      particular revision, of the software. This will normally be a copy of the
      HEAD version at a given revision, although it may be updated with some
      backward compatible fixes.</dd>
    </dl>

    <p>Each change in the HEAD version that requires an upgrade procedure
    should introduce an upgrade macro. Each upgrade macro will provide the
    following information:</p>

    <ul>
      <li>A tag of the configuration which can be applied by this macro (i.e.
      the previous tag).</li>

      <li>A tag of the configuration after the transformation.</li>
    </ul>

    <p>This allows our system to build up a chain if multiple upgrades need to
    be applied. The tag can be any name, but will normally refer to the ticket
    number that introduces the change.</p>

    <p>Every new upgrade macro creates a new tagged version. A named version is
    simply a tagged version for which a copy of the relevant configuration
    metadata is made available.</p>

    <p>Named versions for system releases are typically created at the end of
    the release process. The associated upgrade macro is typically only
    required in order to create the new name tag and, therefore, does not
    normally alter the application configuration.</p>

    <p>Application configurations can reference the configuration metadata as
    follows:</p>
    <pre class="prettyprint lang-rose_conf">
#!cfg
# Refer to the HEAD version
# (typically you wouldn't do this since no upgrade process is possible)
meta=my-command

# Refer to a named or tagged version
meta=my-command/8.3
meta=my-command/t123
</pre>

    <p>If a version is defined then the Rose utilities will first look for the
    corresponding named version. If this cannot be found then the HEAD version
    is used and, if an upgrade is available, a warning will be given to
    indicate that the configuration metadata being used requires upgrade macros
    to be run. If the version defined does not correspond to a tagged version
    then a warning will be given.</p>

    <h3 id="appendix-upgrade:named">When to create named versions</h3>

    <p>One option is to create a new named version for each release of your
    system. This makes it easy for users to understand. However, if there is a
    new release which does not require a change to the metadata then you will
    still have to create a new copy and force the user to go through a null
    upgrade which may not be desirable. An alternative is to only create a new
    named version at releases which require changes. The name then indicates
    the metadata is relevant for a particular release and all subsequent
    releases (unless an upgrade macro is available to a later release).</p>

    <p>It is also possible to make any tagged version between releases a named
    version, but it will usually be better not to. In which case, the user will
    be using HEAD and will be prompted to upgrade (which is probably what you
    want if you're not using a release).</p>

    <h3 id="appendix-upgrade:share">Sharing metadata between different
    executables</h3>

    <p>If 2 different commands share the majority of their inputs then you may
    choose to use the same configuration metadata for both commands. Any
    differences (in terms of available inputs) can then be triggered by the
    command in use. Whether this is desirable will partly depend on how many of
    the inputs are shared.</p>

    <p>One downside of sharing metadata is that your application configuration
    may contain (ignored) settings which have no relevance to the command you
    are using.</p>

    <p>Note that we intend to introduce support for configuration metadata to
    include / inherit from other metadata. This may mean that it makes sense to
    have separate metadata for different commands even when the majority of
    inputs are shared.</p>

    <p>Another reason you may want to share metadata is if you have 2 related
    commands which you want to configure using the same set of inputs (i.e. a
    single application configuration).</p>

    <p>This works by setting an alternate command in the application
    configuration and then using the `--command-key` option to `rose
    app-run`.</p>

    <h3 id="appendix-upgrade:dev">Using development versions of upgrade
    macros</h3>

    <p>Users will be able to test out development versions of the upgrade
    macros by adding a working copy of the relevant branch into their metadata
    search path. However, care must be taken when doing this. Running the
    upgrade macro will change the `meta` setting to refer to the new tag. If
    the upgrade macro is subsequently changed or other upgrade macros are added
    to the chain prior to this tag (because they get committed to the trunk
    first) then this will result in application configurations which have not
    gone through the correct upgrade process. Therefore, when using development
    versions of the upgrade macros it is safest to not commit any resulting
    changes (or to use a branch of the suite which you are happy to
    discard).</p>

    <h2 id="appendix-mini-language">Appendix: Metadata Mini-Language</h2>

    <p>The Rose metadata mini-language supports writing a logical expression in
    Python-like syntax, using variable ids to reference their associated
    values.</p>

    <p>Expressions are set as the value of metadata properties such as <a href=
    "#meta.conf.value.fail-if"><code>fail-if</code></a> and <a href=
    "#meta.conf.value.range"><code>range</code></a>.</p>

    <p>The language is a small sub-set of Python - a limited set of operators
    is supported. No built-in object methods, functions, or modules are
    supported - neither are control blocks such as
    <samp>if</samp>/<samp>for</samp>, statements such as <samp>del</samp> or
    <samp>with</samp>, or defining your own functions or classes. Anything that
    requires that kind of power should be in proper Python code as a macro.</p>

    <p>Nevertheless, the language allows considerable power in terms of
    defining simple rules for variable values.</p>

    <h3 id="appendix-mini-language-operators">Operators</h3>

    <p>The following <em>numeric</em> operators are supported:</p>
    <pre class="prettyprint lang-python">
+     # add
-     # subtract
*     # multiply
**    # power or exponent - e.g. 2 ** 3 implies 8
/     # divide
//    # integer divide (floor) - e.g. 3 // 2 implies 1
%     # remainder e.g. 5 % 3 implies 2
</pre>

    <p>The following <em>string</em> operators are supported:</p>
    <pre class="prettyprint lang-python">
+      # concatenate - e.g. "foo" + "bar" implies "foobar"
*      # self-concatenate some number of times - e.g. "foo" * 2 implies "foofoo"
%      # formatting - e.g. "foo %s baz" % "bar" implies "foo bar baz"
in     # contained in (True/False) - e.g. "oo" in "foobar" implies True
not in # opposite sense of in

# Where m, n are integers or expressions that evaluate to integers
# (negative numbers count from the end of the string):
[n]   # get nth character from string - e.g. "foo"[1] implies "o"
[m:n] # get slice of string from m to n - e.g. "foobar"[1:5] implies "ooba"
[m:]  # get slice of string from m onwards - e.g. "foobar"[1:] implies "oobar"
[:n]  # get slice of string up to n - e.g. "foobar"[:5] implies "fooba"
</pre>

    <p>The following <em>logical</em> operators are supported:</p>
    <pre class="prettyprint lang-python">
and   # Logical AND
or    # Logical OR
not   # Logical NOT
</pre>

    <p>The following <em>comparison</em> operators are supported:</p>
    <pre class="prettyprint lang-python">
is    # Is the same object as (usually used for 'is none')
&lt;     # Less than 
&gt;     # Greater than
==    # Equal to
&gt;=    # Greater than or equal to
&lt;=    # Less than or equal to
!=    # Not equal to
</pre>

    <p>Operator precedence is intended to be the same as Python. However, with
    the current choice of language engine, the <samp>%</samp> and
    <samp>//</samp> operators may not obey this - make sure you force the
    correct behaviour using brackets.</p>

    <h3 id="appendix-mini-language-constants">Constants</h3>

    <p>The following are special constants:</p>
    <pre class="prettyprint lang-python">
None  # Python None
False # Python False
True  # Python True
</pre>

    <h3 id="appendix-mini-language-ids">Using Variable Ids</h3>

    <p>Putting a variable id in the expression means that when the expression
    is evaluated, the string value of the variable is <a href=
    "http://docs.python.org/2/library/ast.html#ast.literal_eval">cast</a> and
    substituted into the expression.</p>

    <p>For example, if we have a configuration that looks like this:</p>
    <pre class="prettyprint lang-rose_conf">
[namelist:zoo]
num_elephants=2
elephant_mood='peaceful'
</pre>

    <p>and an expression in the configuration metadata:</p>
    <pre class="prettyprint lang-python">
namelist:zoo=elephant_type != 'annoyed' and num_elephants &gt;= 2
</pre>

    <p>then the expression would become:</p>
    <pre class="prettyprint lang-python">
'peaceful' != 'annoyed' and 2 &gt;= 2
</pre>

    <p>If the variable is not currently available (ignored or missing) then the
    expression cannot be evaluated. If inter-variable comparisons are not
    allowed for the expression's parent option (such as with
    <samp>trigger</samp> and <samp>range</samp>) then referencing other
    variable ids is not allowed.</p>

    <p>In this case the expression would be false.</p>

    <p>You may use <samp>this</samp> as a placeholder for the current variable
    id - for example, the fail-if expression:</p>
    <pre class="prettyprint lang-rose_conf">
[namelist:foo=bar]
fail-if=namelist:foo=bar &gt; 100 and namelist:foo=bar % 2 == 1
</pre>

    <p>is the same as:</p>
    <pre class="prettyprint lang-rose_conf">
[namelist:foo=bar]
fail-if=this &gt; 100 and this % 2 == 1
</pre>

    <h3 id="appendix-mini-language-arrays">Arrays</h3>

    <p>The syntax has some special ways of dealing with variable values that
    are arrays - i.e. comma-separated lists.</p>

    <p>You can refer to a single element of the value for a given variable id
    (or <samp>this</samp>) by suffixing a number in round brackets - e.g.:</p>
    <pre class="prettyprint lang-python">
namelist:foo=bar(2)
</pre>

    <p>references the second element in the value for <samp>bar</samp> in the
    section <samp>namelist:foo</samp>. This follows Fortran index numbering and
    syntax, which starts at 1 rather than 0 - i.e. referencing the 1st element
    in the array <var>foo</var> is written as <samp>foo(1)</samp>.</p>

    <p>If we had a configuration:</p>
    <pre class="prettyprint lang-rose_conf">
[namelist:foo]
bar='a', 'b', 'c', 'd'
</pre>

    <p><samp>namelist:foo=bar(2)</samp> would get substituted in an expression
    with <samp>'b'</samp> when the expression was evaluated. For example, an
    expression that contained:</p>
    <pre class="prettyprint lang-python">
namelist:foo=bar(2) == 'c'
</pre>

    <p>would be evaluated as:</p>
    <pre class="prettyprint lang-python">
'b' == 'c'
</pre>

    <p>There are two special array functions, <samp>any</samp> and
    <samp>all</samp>, which behave in a similar fashion to their Python and
    Fortran equivalents, but have a different syntax.</p>

    <p>They allow you to write a shorthand expression within an
    <samp>any()</samp> or <samp>all()</samp> bracket which implies a loop over
    each array element. For example:</p>
    <pre class="prettyprint lang-python">
any(namelist:foo=bar == 'e')
</pre>

    <p>evaluates true if any elements in the value of <samp>bar</samp> in the
    section <samp>namelist:foo</samp> are <samp>'e'</samp>. For the above
    configuration snippet, this would be expanded before evaluation to be:</p>
    <pre class="prettyprint lang-python">
'a' == 'e' or 'b' == 'e' or 'c' == 'e' or 'd' == 'e'
</pre>

    <p>Similarly,</p>
    <pre class="prettyprint lang-python">
all(namelist:foo=bar == 'e')
</pre>

    <p>evaluates true if <em>all</em> elements are <samp>'e'</samp>. Again,
    with the above configuration, this would be expanded before proper
    evaluation:</p>
    <pre class="prettyprint lang-python">
<samp>'a' == 'e' and 'b' == 'e' and 'c' == 'e' and 'd' == 'e'
</samp>
</pre>

    <h3 id="appendix-mini-language-internals">Internals</h3>

    <p>Rose uses an external engine to evaluate the raw language string after
    variable ids and any <samp>any()</samp> and <samp>all()</samp> functions
    have been substituted and expanded.</p>

    <p>The current choice of engine is <a href=
    "http://jinja.pocoo.org/docs/">Jinja2</a>, which is responsible for the
    details of the supported Pythonic syntax. This may change.</p>

    <p><strong>Do not use any Jinja2-specific syntax.</strong></p>

    <h2 id="appendix-ignored-config-edit">Appendix: Config Editor Ignored
    Mechanics</h2>

    <p>This describes the intended behaviour of the config editor when there is
    an ignored state mismatch for a setting - e.g. a setting might be enabled
    when it should be trigger-ignored.</p>

    <p>The table contains error and fixing information for some varieties of
    ignored state mismatches. The actual situations are considerably more
    varied, given section-ignoring and latent variables - the table holds the
    most important varieties.</p>

    <p>The <samp>State</samp> contains the actual states. The <samp>Trigger
    State</samp> column contains the trigger-mechanism's expected states. The
    states can be:</p>

    <dl>
      <dt class="trigger-ignored">I<sub>T</sub> - <var>!!</var></dt>

      <dd>trigger ignored</dd>

      <dt class="user-ignored">I<sub>U</sub> - <var>!</var></dt>

      <dd>user ignored</dd>

      <dt>E - (normal)</dt>

      <dd>enabled</dd>
    </dl>

    <table summary=
    "A subset of possible ignored/enabled states, errors and fixes">
      <caption>
        A subset of possible ignored/enabled states, errors and fixes
      </caption>

      <tr>
        <th>State</th>

        <th>Trigger State</th>

        <th>Compulsory</th>

        <th>Display Error?</th>

        <th>User Options</th>

        <th>Notes</th>
      </tr>

      <tr>
        <td class="trigger-ignored">I<sub>T</sub></td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>compulsory</td>

        <td>no</td>

        <td>None</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td class="trigger-ignored">I<sub>T</sub></td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>optional</td>

        <td>no</td>

        <td>None</td>

        <td>config editor shows non-functional E option for implementation
        reasons. <span class="user-ignored">I<sub>U</sub></span> is possible as
        well, but creates a more confused state and presents an ignored option
        for an already-ignored setting</td>
      </tr>

      <tr>
        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>E</td>

        <td>compulsory</td>

        <td class="fail">error</td>

        <td>E</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>E</td>

        <td>optional</td>

        <td class="fail">error</td>

        <td>E</td>

        <td class="caption">I<sub>U</sub> not given for above reasons.</td>
      </tr>

      <tr>
        <td class="trigger-ignored">I<sub>T</sub></td>

        <td class="not-trigger">not trigger</td>

        <td>compulsory</td>

        <td class="fail">error</td>

        <td>E</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td class="trigger-ignored">I<sub>T</sub></td>

        <td class="not-trigger">not trigger</td>

        <td>optional</td>

        <td class="warn">overlook</td>

        <td>E</td>

        <td>overlooking mainly in order to de-clutter the <kbd>No
        Metadata</kbd> view. <span class="user-ignored">I<sub>U</sub></span>
        not given for above reasons.</td>
      </tr>

      <tr>
        <td class="user-ignored">I<sub>U</sub></td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>compulsory</td>

        <td class="warn">overlook</td>

        <td>None</td>

        <td>same basic state, won't mess with trigger too much. macro will ask
        to fix this.</td>
      </tr>

      <tr class="odd">
        <td class="user-ignored">I<sub>U</sub></td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>optional</td>

        <td>no</td>

        <td>None</td>

        <td>&nbsp;</td>
      </tr>

      <tr>
        <td class="user-ignored">I<sub>U</sub></td>

        <td>E</td>

        <td>compulsory</td>

        <td class="fail">error</td>

        <td>E</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td class="user-ignored">I<sub>U</sub></td>

        <td>E</td>

        <td>optional</td>

        <td>no</td>

        <td>E</td>

        <td>&nbsp;</td>
      </tr>

      <tr>
        <td class="user-ignored">I<sub>U</sub></td>

        <td class="not-trigger">not trigger</td>

        <td>compulsory</td>

        <td class="fail">error</td>

        <td>E</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td class="user-ignored">I<sub>U</sub></td>

        <td class="not-trigger">not trigger</td>

        <td>optional</td>

        <td>no</td>

        <td>E</td>

        <td>&nbsp;</td>
      </tr>

      <tr>
        <td>E</td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>compulsory</td>

        <td class="fail">error</td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td>E</td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>optional</td>

        <td class="fail">error</td>

        <td class="trigger-ignored">I<sub>T</sub></td>

        <td>adding the <span class="user-ignored">I<sub>U</sub></span> option
        would be confusing.</td>
      </tr>

      <tr>
        <td>E</td>

        <td>E</td>

        <td>compulsory</td>

        <td>no</td>

        <td>None</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td>E</td>

        <td>E</td>

        <td>optional</td>

        <td>no</td>

        <td class="user-ignored">I<sub>U</sub></td>

        <td>&nbsp;</td>
      </tr>

      <tr>
        <td>E</td>

        <td class="not-trigger">not trigger</td>

        <td>compulsory</td>

        <td>no</td>

        <td>None</td>

        <td>&nbsp;</td>
      </tr>

      <tr class="odd">
        <td>E</td>

        <td class="not-trigger">not trigger</td>

        <td>optional</td>

        <td>no</td>

        <td class="user-ignored">I<sub>U</sub></td>

        <td>&nbsp;</td>
      </tr>
    </table>
  </div>
</body>
</html>
