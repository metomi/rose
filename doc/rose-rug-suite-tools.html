<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Rose User Guide: Suite Tools</title>
  <meta name="author" content="Rose Team, Met Office, UK" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="icon" href="rose-icon.png" type="image/png" />
  <link rel="shortcut icon" href="rose-icon.png" type="image/png" />
  <link rel="stylesheet" type="text/css" href="rose-doc.css" />
  <link rel="stylesheet" type="text/css" href=
  "google-code-prettify/prettify.css" />
  <script type="text/javascript" src="jquery.min.js">
</script>
  <script type="text/javascript" src="google-code-prettify/prettify.js">
</script>
  <script type="text/javascript" src="prettify-rose-conf.js">
</script>
  <script type="text/javascript" src="rose-doc.js">
</script>
  <script type="text/javascript" src="rose-version.js">
</script>
</head>

<body>
  <div class="header-footer" id="body-header">
    <address>
      &copy; British Crown Copyright 2012-3 <a href=
      "http://www.metoffice.gov.uk">Met Office</a>. See <a href=
      "rose-terms-of-use.html">Terms of Use</a>.<br />
      This document is released under the <a href=
      "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
      "license">Open Government Licence</a>.<br />
      <span id="rose-version"></span>
    </address>

    <div class="rose-link">
      <img id="rose-icon" src="rose-icon.png" alt="Rose" />

      <p><a id="doc-home-link" href="." name="doc-home-link">Rose
      Documentation</a></p>
    </div>
  </div>

  <div id="body-main">
    <h1>Rose User Guide: Suite Tools</h1>

    <div id="content"></div>

    <h2 id="intro">Introduction</h2>

    <p>This chapter of the user guide discusses the Rose suite tools and
    utilities that can be used to simplify the logic of a suite and/or provide
    a common approach of doing the same things.</p>

    <h2 id="rose-task-run">rose task-run</h2>

    <p>The command uses the suite engine environment to set up some standard
    <var>ROSE_*</var> environment variables, site/user specific <var>PATH</var>
    and similar variables, etc. for the task before launching an
    application.</p>

    <p>See <a href="rose-command.html#rose-task-run">Rose Reference Guide: CLI
    &gt; rose task-run</a> for a full command reference.</p>

    <p>See <a href="rose-configuration.html#format">Rose Reference Guide:
    Configuration &gt; Configuration Format</a> for more information on Rose
    configuration format.</p>

    <p>See <a href="rose-configuration.html#app">Rose Reference Guide:
    Configuration &gt; Application Configuration</a> for more information on
    how to set up a Rose application configuration.</p>

    <h3 id="rose-task-run.app">Application Configuration Selection</h3>

    <p>In a normal case, the command will look at the suite's <var>app/</var>
    directory for an application configuration that matches the name of the
    task, and run the application based on the configuration. If you need to
    select an alternate application configuration or if the name of the task
    would not match any application configuration of the suite, you can use the
    <code>--app-key=KEY</code> option or the <var>ROSE_TASK_APP</var>
    environment variable to specify the name of the application configuration
    the task should use.</p>

    <h3 id="rose-task-run.command">Command Selection</h3>

    <p>The application runner uses the following logic to select a shell
    command to run:</p>

    <ol>
      <li>If arguments are supplied to <code>rose task-run</code>, the
      arguments are run as a shell command.</li>

      <li>If the <code>--command-key=KEY</code> option is specified, the
      command specified in the <var>[command]KEY</var> setting in the
      application configuration file is used.</li>

      <li>If the <var>[command]</var> section in the application configuration
      file has a key matching the task name, the command specified in this
      setting is used.</li>

      <li>Otherwise, the command specified in the <var>[command]default</var>
      setting is used.</li>
    </ol>

    <p>This mechanism allows, for example, similar tasks to share the same
    application configuration, if most of their differences can be defined at
    the command line.</p>

    <h3 id="rose-task-run.env">Environment Variables Export</h3>

    <p>The application runner exports each environment variables in the
    <var>[env]</var> section in the application configuration file in no
    particular oder, before doing anything else. The file installation sections
    and the application command can reference the environment variables
    exported in the <var>env</var> section.</p>

    <h3 id="rose-task-run.file">File Installation</h3>

    <p>See <a href="rose-configuration.html#appendix-file-creation-mode">Rose
    Reference Guide: Configuration &gt; Appendix: File Creation Mode</a>.</p>

    <h3 id="rose-task-run.builtin-app">Builtin Applications Selection</h3>

    <p>Apart from running command normally, the <code>rose task-run</code>
    command (or the <code>rose app-run</code> command) also has a set of
    built-in applications to call. To use a builtin application, add the
    <kbd>mode=KEY</kbd> setting in the application configuration, where
    <var>KEY</var> is the name of a builtin application. (See below.)</p>

    <p>A builtin application would normally behave very much like running an
    external command. The key differences are normally that:</p>

    <ol>
      <li>A builtin application may use a different working directory to a Rose
      application.</li>

      <li>A builtin application will run some pre-defined commands or logics
      instead of a command defined in the application configuration.</li>
    </ol>

    <h2 id="rose-task-run.builtin-app.fcm_make">Builtin Application:
    fcm_make</h2>

    <p>The <code>fcm_make</code> built-in applications is provided for running
    <code>fcm make</code>.</p>

    <p>N.B. If a task has a name that starts with <var>fcm_make*</var>,
    <code>rose task-run</code> will run this builtin application.</p>

    <p>N.B. If a task has a name that starts with <var>fcm_make2*</var> and it
    does not have its own application configuration, <code>rose task-run</code>
    will attempt to associate it with the corresponding <var>fcm_make*</var>
    application configuration.</p>

    <p>The <code>fcm_make</code> application expects a file
    <var>file/fcm-make.cfg</var> in its application configuration. It runs
    <code>fcm make</code> using this configuration file.</p>

    <p>The <code>fcm make</code> application will also look for a matching
    <code>fcm_make2*</code> task in the suite which would normally be a
    continuation of the <code>fcm make</code> command as a separate
    <var>USER@HOST</var>. If so, will export an environment variable
    <var>ROSE_TASK_MIRROR_TARGET</var> to the <code>fcm make</code> command to
    substitute the mirror target.</p>

    <p>You can configure these applications with environment variables or
    settings in <var>rose-app.conf</var>. (Settings in <var>rose-app.conf</var>
    override their equivalent environment variables.)</p>

    <p><kbd>use-pwd=true</kbd>: By default, the application changes the working
    directory to <var>$ROSE_SUITE_DIR/share/$ROSE_TASK_NAME</var>. This option
    will stop this, and the working directory is the normal working directory
    of the task.</p>

    <p><kbd>opt.jobs=N</kbd> or the environment variable
    <var>ROSE_TASK_N_JOBS</var>: This can be used to control the number of
    processes <code>fcm make</code> would use in parallel. (default=4)</p>

    <p><kbd>args</kbd> or the environment variable <var>ROSE_TASK_OPTIONS</var>:
    This can be used to pass extra arguments to the <code>fcm make</code>
    command.</p>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
meta=fcm_make
mode=fcm_make
opt.jobs=8
</pre>

    <h2 id="rose-task-run.util.rose_ana">Builtin Application: rose_ana</h2>

    <p>This built-in application runs <code>rose-ana</code>, the Rose
    comparison engine. This compares files against each other using a
    configurable method and reports whether the files differ or not.</p>

    <p>In automatic selection mode, this built-in application will be invoked
    automatically if a task has a name that starts with
    <code>rose_ana*</code>.</p>

    <p>The built-in application will search the <code>comparisons</code>
    subdirectory of the Rose installation for built-in comparisons, and further
    directories to search can be specified in the <code>rose.conf</code> file
    using the <var>method-path</var> variable in the <var>[rose-ana]</var>
    section.</p>

    <h2 id="rose-task-run.util.rose_arch">Builtin Application: rose_arch</h2>

    <p>This built-in application provides a generic solution to configure site
    specific archiving of suite files. It is designed to work under <code>rose
    task-run</code>.</p>

    <p>In automatic selection mode, this built-in application will be invoked
    automatically if a task has a name that starts with
    <code>rose_arch*</code>.</p>

    <p>The application is normally configured in a <var>rose-app.conf</var>.
    Global settings may be specified in an <kbd>[arch]</kbd> section. Each
    archiving target will have its own <kbd>[arch:TARGET]</kbd> section for
    specific settings, where <var>TARGET</var> would be a URI to the archiving
    location on your site specific archiving system. Settings in a
    <kbd>[arch:TARGET]</kbd> section would override those in the global
    <kbd>[arch]</kbd> section for the given <var>TARGET</var>.</p>

    <p>The application provides some useful functionalities:</p>

    <ul>
      <li>Incremental mode. Store the archive target settings, checksums of
      source files and the return code of archive command. In a retry, it would
      only redo targets that did not succeed in the previous attempts.</li>

      <li>Rename of source files.</li>

      <li>Tar-Gzip or Gzip source files before sending them to the
      archive.</li>
    </ul>

    <p>The following settings are accepted in <kbd>[arch]</kbd> and
    <kbd>[arch:TARGET]</kbd> sections:</p>

    <dl>
      <dt><kbd>command-format=FORMAT</kbd></dt>

      <dd>Compulsory. A Pythonic <code>printf</code> style format string to
      construct the archive command. It must contain the placeholders
      <var>%(sources)s</var> and <var>%(target)s</var> for substitution of the
      sources and the target respectively.</dd>

      <dt><kbd>compress=pax|tar|pax.gz|tar.gz|tgz|gz</kbd></dt>

      <dd>Optional. If specified, compress source files to the given scheme
      before sending them to the archive. If not specified, the compress scheme
      is automatically determined by the file extension of the target, if it
      matches one of the allowed values. For the <var>pax|tar</var> scheme, the
      sources will be placed in a TAR archive before being sent to the target.
      For the <var>pax.gz|tar.gz|tgz</var> scheme, the sources will be placed
      in a TAR-GZIP file before being sent to the target. For the <var>gz</var>
      scheme, each source file will be compressed by GZIP before being sent to
      the target.</dd>

      <dt><kbd>rename-format</kbd></dt>

      <dd>Optional. If specified, the source files will be renamed according to
      the specified format. The format string should be a Pythonic
      <code>printf</code> style format string. It may contain the placeholder
      <var>%(cycle)s</var> (for the current <var>$ROSE_TASK_CYCLE_TIME</var>,
      the placeholder <var>%(name)s</var> for the name of the file, and/or
      named placeholders that are generated by <kbd>rename-parser</kbd>.</dd>

      <dt><kbd>rename-parser</kbd></dt>

      <dd>Optional. Ignored if <kbd>rename-format</kbd> is not specified.
      Specify a regular expression to parse the name of a source. The regular
      expression should do named captures of strings from source file names,
      which can then be used to substitute named placeholders in the
      corresponding <kbd>rename-format</kbd>.</dd>

      <dt><kbd>source=NAME</kbd></dt>

      <dd>Compulsory for each <kbd>[arch:TARGET]</kbd> section. Specify a list
      of space delimited source file names and/or globs for matching source
      file names. (File names with space or quote characters can be escaped
      using quotes or backslashes, like in a shell.) Paths are assumed to be
      relative to <var>$ROSE_SUITE_DIR</var> or to
      <var>$ROSE_SUITE_DIR/PREFIX</var> if <kbd>source-prefix=PREFIX</kbd> is
      specified.</dd>

      <dt><kbd>source-edit-format=FORMAT</kbd></dt>

      <dd>Optional. A Pythonic <code>printf</code> style format string to
      construct a command to edit or modify the content of source files before
      archiving them. It must contain the placeholders <var>%(in)s</var> and
      <var>%(out)s</var> for substitution of the path to the source file and the
      path to the modified source file (which will be created in a temporary
      working directory).</dd>

      <dt><kbd>source-prefix=PREFIX</kbd></dt>

      <dd>Optional. Add a prefix to each value in a source declaration. A
      trailing slash should be added for a directory. Paths are assumed to be
      relative to <var>$ROSE_SUITE_DIR</var>. This setting serves 2 purposes.
      It provides a way to avoid typing the same thing repeatedly. It also
      modifies the name-spaces of the sources if the target is in a TAR or
      TAR-GZIP file. In the absence of this setting, the name of a source in a
      TAR or TAR-GZIP file is the path relative to <var>$ROSE_SUITE_DIR</var>.
      By specifying this setting, the source names in a TAR or TAR-GZIP file
      will be shortened by the prefix.</dd>

      <dt><kbd>target-prefix=PREFIX</kbd></dt>

      <dd>Optional. Add a prefix to each target declaration. This setting
      provides a way to avoid typing the same thing repeatedly. A trailing
      slash (or whatever is relevant for the archiving system) should be added
      for a directory.</dd>

      <dt><kbd>update-check=md5sum|mtime+size</kbd></dt>

      <dd>Optional. Specify the method for checking whether a source has changed
      since the previous run. The default is to use the MD5 checksum of the
      content of each source file. The alternate method is to use the modified
      time and size of the source, which is useful for large files, but is less
      correct.</dd>
    </dl>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
# General settings
[arch]
command-format=foo put %(target)s %(sources)s
source-prefix=$ROSE_DATAC/
target-prefix=foo://hello/

# Archive a file to a file
[arch:world.out]
source=hello/world.out

# Auto gzip
[arch:planet.out.gz]
source=hello/planet.out

# Archive files matched by a glob to a directory
[arch:worlds/]
source=hello/worlds/*

# Auto tar-gzip
[arch:galaxies.tar.gz]
source-prefix=hello/
source=galaxies/*
# File with multiple galaxies may be large, don't do its checksum
update-check=mtime+size

# Force gzip each source file
[arch:stars/]
source=stars/*
compress=gzip

# Source name transformation
[arch:moons.tar.gz]
source=moons/*
rename-format=%(cycle)s-%(name)s
source-edit-format=sed 's/Hello/Greet/g' %(in)s &gt;%(out)s

# Source name transformation with a rename-parser
[arch:unknown/stuff.pax]
rename-format=hello/%(cycle)s-%(name_head)s%(name_tail)s
rename-parser=^(?P&lt;name_head&gt;stuff)ing(?P&lt;name_tail&gt;-.*)$
source=stuffing-*.txt

# ...
</pre>

    <h2 id="rose-task-run.util.rose_prune">Builtin Application: rose_prune</h2>

    <p>This built-in application offers a way to housekeep a cycling suite. It
    prunes files and directories generated by suite tasks. It is designed to
    work under <code>rose task-run</code> on the host that runs the suite
    daemon.</p>

    <p>In automatic selection mode, this built-in application will be invoked
    automatically if a task has a name that starts with
    <code>rose_prune*</code>.</p>

    <p>The application is normally configured in the <kbd>[prune]</kbd> section
    in a <var>rose-app.conf</var>.</p>

    <p>All settings are expressed as a space delimited list of cycles, normally
    as date/time offsets relative to the current cycle, in a format recognised
    by the <code>--offset=OFFSET</code> option of <code>rose date</code>. E.g.
    <kbd>-1d6h</kbd> is 1 day and 6 hours before the current cycle time.</p>

    <p>The cycles of some settings also accept an optional argument followed by
    a colon. In these, the argument should be globs for matching items in the
    directory. If two or more globs are required, they should be separated by a
    space. In which case, either the argument should be quoted or the space
    should be escaped by a backslash.</p>

    <p>The following settings are accepted:</p>

    <dl>
      <dt><kbd>prune-remote-logs-at=cycle ...</kbd></dt>

      <dd>Re-sync remote job logs at these cycles and remove them from remote
      hosts.</dd>

      <dt><kbd>archive-logs-at=cycle ...</kbd></dt>

      <dd>Archive all job logs at these cycles. Remove remote job logs on
      success.</dd>

      <dt><kbd>prune-work-at=cycle[:globs] ...</kbd></dt>

      <dd>Remove the work directories of the specified cycles. If globs are
      specified for a cycle, only items matching the globs in the work
      directories of the specified cycle will be pruned.</dd>

      <dt><kbd>prune-datac-at=cycle[:globs] ...</kbd></dt>

      <dd>Remove the <var>ROSE_DATAC</var> of the specified cycles. If globs
      are specified for a cycle, only items matching the globs in the
      <var>ROSE_DATAC</var> directories of the specified cycle will be
      pruned.</dd>
    </dl>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
meta=rose_prune
mode=rose_prune

[prune]
prune-remote-logs-at=-6h
archive-logs-at=-1d
prune-work-at=-12h
prune-datac-at=-6h:foo* -12h:'bar* *.baz*' -1d
</pre>

    <h2 id="rose-task-env">rose task-env</h2>

    <p>There are times when extra environment needs to be defined before
    launching <code>rose task-run</code>. This is where <code>rose
    task-env</code> may come in handy. The command prints to the
    <var>STDOUT</var> the standard Rose task environment variables (which are
    normally provided by <code>rose task-run</code>) in a syntax compatible to
    <a href="http://www.gnu.org/software/bash/">bash</a> / <a href=
    "http://www.kornshell.com/">ksh</a>. This means that the output of this
    command can be shell <code>eval</code> into the current environment.
    E.g.</p>
    <pre class="shell">
eval $(rose task-env)
</pre>

    <p>See <a href="rose-command.html#rose-task-env">Rose Reference Guide: CLI
    &gt; rose task-env</a> for a full list of environment variables provided by
    this command.</p>

    <h2 id="rose-app-run">rose app-run</h2>

    <p>Run an application according to its configuration, outside of a
    suite task environment. Although you will normally launch a Rose
    application using <code>rose task-run</code>, there are situations when
    you may have a standalone Rose application configuration that you just
    want to run outside of a suite. This is where <code>rose app-run</code>
    may come in handy.</p>

    <p>See <a href="rose-command.html#rose-app-run">Rose Reference Guide:
    CLI &gt; rose app-run</a> for a full list of environment variables
    provided by this command.</p>
  </div>
</body>
</html>
