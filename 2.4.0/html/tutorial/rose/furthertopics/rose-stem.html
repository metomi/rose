



<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rose Stem &mdash; Rose Documentation 2.4.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=659b1fac" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/diff_selector.css?v=9704a72b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/grid_table.css?v=0285b42e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/hieroglyph_theme_addons.css?v=814c2015" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/tutorial.css?v=b869d33c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/addons.css?v=d1f804c3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=466af0f7" />

  
    <link rel="shortcut icon" href="../../../_static/rose-favicon.png"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=4d935f96"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/js/diff_selector.js?v=3109bfa4"></script>
      <script src="../../../_static/js/minicylc.js?v=ddc882fd"></script>
      <script src="../../../_static/js/spoiler.js?v=12631137"></script>
      <script src="../../../_static/js/addons.js?v=39bd7dee"></script>
      <script src="../../../_static/js/versioning.js?v=df0214e8"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Rose Stem Tutorial" href="rose-stem-tutorial.html" />
    <link rel="prev" title="Rose Bunch" href="rose-bunch.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/rose-logo-crop.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Rose Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../configurations.html">Rose Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../applications.html">Rose Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata.html">Rose Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../suites.html">Rose Suite Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../summary.html">Summary</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Further Topics</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="command-keys.html">Command Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="date-time-manipulation.html">Date and Time Manipulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="failif-warnif.html">Fail-If, Warn-If</a></li>
<li class="toctree-l3"><a class="reference internal" href="macro-development.html">Custom Macros</a></li>
<li class="toctree-l3"><a class="reference internal" href="optional-configurations.html">Optional Configurations</a></li>
<li class="toctree-l3"><a class="reference internal" href="polling.html">Polling</a></li>
<li class="toctree-l3"><a class="reference internal" href="rose-arch.html">Rose Arch</a></li>
<li class="toctree-l3"><a class="reference internal" href="rose-bunch.html">Rose Bunch</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Rose Stem</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#motivation">Motivation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Rose Stem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-a-suite-with-command-rose-stem">Running A Suite With <span class="xref std std-ref">command-rose-stem</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-source-argument">The <code class="docutils literal notranslate"><span class="pre">--source</span></code> Argument</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-group-argument">The <code class="docutils literal notranslate"><span class="pre">--group</span></code> Argument</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-task-argument">The <code class="docutils literal notranslate"><span class="pre">--task</span></code> Argument</a></li>
<li class="toctree-l4"><a class="reference internal" href="#comparing-output-with-rose-ana">Comparing Output With <code class="xref rose rose-app docutils literal notranslate"><span class="pre">rose_ana</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-rose-ana-comparison-database">The Rose Ana Comparison Database</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="rose-stem-tutorial.html">Rose Stem Tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="rosie.html">Rosie</a></li>
<li class="toctree-l3"><a class="reference internal" href="trigger.html">Trigger</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading.html">Upgrading</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrading-macro-development.html">Upgrading Macro Development</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Rose API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/configuration/index.html">Rose Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/command-reference.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/environment-variables.html">Rose Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/other.html">Other Python API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-bash-library.html">Rose Bash Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-built-in-applications.html">Rose Built-In Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-macro.html">Rose Macro API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rose-upgrader-macros.html">Rose Upgrade Macro API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/rosie-web.html">Rosie Web API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../terms.html">Rose Terms Of Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../course/um-ut.html">UM User Tutorial</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Rose Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Rose Tutorial</a></li>
          <li class="breadcrumb-item"><a href="index.html">Further Topics</a></li>
      <li class="breadcrumb-item active">Rose Stem</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/metomi/rose/blob/master/sphinx/tutorial/rose/furthertopics/rose-stem.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">start-line<span class="colon">:</span></dt>
<dd class="field-odd"><p>1</p>
</dd>
</dl>
</div></blockquote>
<section id="rose-stem">
<span id="id1"></span><h1>Rose Stem<a class="headerlink" href="#rose-stem" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Rose Stem command is provided by the <a class="reference external" href="https://github.com/cylc/cylc-rose">Cylc Rose</a> package.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://cylc.github.io/cylc-doc/stable/html/plugins/cylc-rose.html#rose-stem" title="(in Cylc v8.3)"><span>Rose Stem</span></a> documentation.</p>
</div>
<p>Rose Stem is a testing system for use with Rose. It provides a user-friendly
way of defining source trees and tasks on the command line which are then
passed by Rose Stem to the suite as Jinja2 variables.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Rose Stem requires the use of <a class="reference external" href="https://metomi.github.io/fcm/doc/">FCM</a> as it requires some of the version
control information.</p>
</div>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading"></a></h2>
<p>Why do we test code?</p>
<p>Most people would answer something along the lines of “so we know it works”.</p>
<p>However, this is really asking two related but separate questions.</p>
<ol class="arabic simple">
<li><p>Does the code do what I meant it to do?</p></li>
<li><p>Does the code do anything I didn’t mean it to do?</p></li>
</ol>
<p>Answering the first question may involve writing a bespoke test and checking
the results. The second question can at least partially be answered by using
an automated testing system which runs predefined tasks and presents the
answers. Rose Stem is a system for doing this.</p>
<p>N.B. When writing tests for new code, they should be added to the testing
system so that future developers can be confident that they haven’t broken
the new functionality.</p>
</section>
<section id="id2">
<h2>Rose Stem<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<p>There are two components in Rose Stem:</p>
<dl class="simple">
<dt><a class="reference internal" href="../../../api/command-reference.html#command-rose-stem"><span class="std std-ref">rose stem</span></a></dt><dd><p>The command line tool which executes an appropriate suite.</p>
</dd>
<dt><a class="reference internal" href="../../../api/built-in/rose_ana.html#rose:app:rose_ana" title="rose:app:rose_ana"><code class="xref rose rose-app docutils literal notranslate"><span class="pre">rose_ana</span></code></a></dt><dd><p>A Rose built-in application which can compare the result of a task against
a control.</p>
</dd>
</dl>
<p>We will describe each in turn. It is intended that a test suite lives
alongside the code in the same version-controlled project, which should
encourage developers to update the test suite when they update the code.
This means that the test suite will always be a valid test of the code
it is accompanying.</p>
</section>
<section id="running-a-suite-with-command-rose-stem">
<h2>Running A Suite With <a class="reference internal" href="../../../api/command-reference.html#command-rose-stem"><span class="std std-ref">rose stem</span></a><a class="headerlink" href="#running-a-suite-with-command-rose-stem" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">stem</span></code> command is essentially a wrapper to
<a class="reference external" href="https://cylc.github.io/cylc-doc/stable/html/user-guide/installing-workflows.html#install-workflow" title="(in Cylc v8.3)"><span class="xref std std-ref">cylc install</span></a>, which accepts some additional
arguments and converts them to Jinja2 variables which the workflow can
interpret.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At Cylc 8/Rose 2 <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">stem</span></code> <em>only</em> wraps
<a class="reference external" href="https://cylc.github.io/cylc-doc/stable/html/user-guide/installing-workflows.html#install-workflow" title="(in Cylc v8.3)"><span class="xref std std-ref">cylc install</span></a>, so you will need to invoke
<a class="reference external" href="https://cylc.github.io/cylc-doc/stable/html/user-guide/running-workflows/scheduler-start-up.html#workflowstartup" title="(in Cylc v8.3)"><span class="xref std std-ref">cylc play</span></a> to run your workflow. You may also
wish to validate your workflow (before or after installing it using)
<code class="docutils literal notranslate"><span class="pre">cylc</span> <span class="pre">validate</span> <span class="pre">&lt;workflow</span> <span class="pre">name&gt;</span></code>.</p>
</div>
<p>These arguments are:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">--source</span></code></dt><dd><p>Specifies a source tree to include in a suite.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--group</span></code></dt><dd><p>Specifies a group of tasks to run.</p>
</dd>
</dl>
<p>A group is a set of Rose tasks which together test a certain configuration
of a program.</p>
</section>
<section id="the-source-argument">
<h2>The <code class="docutils literal notranslate"><span class="pre">--source</span></code> Argument<a class="headerlink" href="#the-source-argument" title="Link to this heading"></a></h2>
<p>The source argument provides a set of Jinja2 variables which can then be
included in any compilation tasks in a suite. You can specify multiple
<code class="docutils literal notranslate"><span class="pre">--source</span></code> arguments on the command line. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">stem</span> <span class="o">--</span><span class="n">source</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">workingcopy</span> <span class="o">--</span><span class="n">source</span><span class="o">=</span><span class="n">fcm</span><span class="p">:</span><span class="n">other_project_tr</span><span class="nd">@head</span>
</pre></div>
</div>
<p>Each source tree is associated with a project (via an <code class="docutils literal notranslate"><span class="pre">fcm</span></code> command) when
<a class="reference internal" href="../../../api/command-reference.html#command-rose-stem"><span class="std std-ref">rose stem</span></a> is run on the command line. This project name
is then used in the construction of the Jinja2 variable names.</p>
<p>Each project has a Jinja2 variable <code class="docutils literal notranslate"><span class="pre">SOURCE_FOO</span></code> where <code class="docutils literal notranslate"><span class="pre">FOO</span></code> is the
project name. This contains a space-separated list of all sourcetrees
belonging to that project, which can then be given to an appropriate
build task in the suite so it builds those source trees.</p>
<p>Similarly, a <code class="docutils literal notranslate"><span class="pre">HOST_SOURCE_FOO</span></code> variable is also provided. This is
identical to <code class="docutils literal notranslate"><span class="pre">SOURCE_FOO</span></code> except any working copies have the local
hostname prepended. This is to assist building on remote machines.</p>
<p>The first source specified must be a working copy which contains the
Rose Stem suite. The suite is expected to be in a
subdirectory named <code class="docutils literal notranslate"><span class="pre">rose-stem</span></code> off the top of the working copy. This
source is used to generate three additional variables:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">SOURCE_FOO_BASE</span></code></dt><dd><p>The base directory of the project</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">HOST_SOURCE_FOO_BASE</span></code></dt><dd><p>The base directory of the project with the hostname prepended if it is a
working copy</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SOURCE_FOO_REV</span></code></dt><dd><p>The revision of the project (if any)</p>
</dd>
</dl>
<p>These settings override the variables in the <a class="reference internal" href="../../../api/configuration/suite.html#rose:file:rose-suite.conf" title="rose:file:rose-suite.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-suite.conf</span></code></a> file.</p>
<p>These should allow the use of configuration files which control the build
process inside the working copy, e.g. you can refer to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">HOST_SOURCE_FOO_BASE</span><span class="p">}}</span><span class="o">/</span><span class="n">fcm</span><span class="o">-</span><span class="n">make</span><span class="o">/</span><span class="n">configs</span><span class="o">/</span><span class="n">machine</span><span class="o">.</span><span class="n">cfg</span><span class="p">{{</span><span class="n">SOURCE_FOO_REV</span><span class="p">}}</span>
</pre></div>
</div>
<p>If you omit the source argument, Rose Stem defaults to assuming that the
current directory is part of the working copy which should be added as a
source tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">stem</span> <span class="o">--</span><span class="n">source</span><span class="o">=.</span>
</pre></div>
</div>
<p>The project to which a source tree belongs is normally automatically
determined using <a class="reference external" href="https://metomi.github.io/fcm/doc/">FCM</a> commands. However, in the case where the source tree
is not a valid FCM URL, or where you wish to assign it to another project,
you can specify this using the <code class="docutils literal notranslate"><span class="pre">--source</span></code> argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">stem</span> <span class="o">--</span><span class="n">source</span><span class="o">=</span><span class="n">foo</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">source</span>
</pre></div>
</div>
<p>assigns the URL <code class="docutils literal notranslate"><span class="pre">/path/to/source</span></code> to the foo project, so the variables
<code class="docutils literal notranslate"><span class="pre">SOURCE_FOO</span></code> and <code class="docutils literal notranslate"><span class="pre">SOURCE_FOO_BASE</span></code> will be set to <code class="docutils literal notranslate"><span class="pre">/path/to/source</span></code>.</p>
</section>
<section id="the-group-argument">
<h2>The <code class="docutils literal notranslate"><span class="pre">--group</span></code> Argument<a class="headerlink" href="#the-group-argument" title="Link to this heading"></a></h2>
<p>The group argument is used to provide a Pythonic list of groups in the
variable <code class="docutils literal notranslate"><span class="pre">RUN_NAMES</span></code> which can then be looped over in a suite to switch
sets of tasks on and off.</p>
<p>Each <code class="docutils literal notranslate"><span class="pre">--group</span></code> argument adds another group to the list. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">stem</span> <span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">mygroup</span> <span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">myothergroup</span>
</pre></div>
</div>
<p>runs two groups named <code class="docutils literal notranslate"><span class="pre">mygroup</span></code> and <code class="docutils literal notranslate"><span class="pre">myothergroup</span></code> with the current
working copy. The suite will then interpret these into a set of tasks which
build with the given source tree(s), run the program, and compare the output.</p>
</section>
<section id="the-task-argument">
<h2>The <code class="docutils literal notranslate"><span class="pre">--task</span></code> Argument<a class="headerlink" href="#the-task-argument" title="Link to this heading"></a></h2>
<p>The task argument is provided as a synonym for <code class="docutils literal notranslate"><span class="pre">--group</span></code>. Depending on how
exactly the Rose Stem suite works users may find one of these arguments more
intuitive to use than the other.</p>
</section>
<section id="comparing-output-with-rose-ana">
<h2>Comparing Output With <a class="reference internal" href="../../../api/built-in/rose_ana.html#rose:app:rose_ana" title="rose:app:rose_ana"><code class="xref rose rose-app docutils literal notranslate"><span class="pre">rose_ana</span></code></a><a class="headerlink" href="#comparing-output-with-rose-ana" title="Link to this heading"></a></h2>
<p>Any task beginning with <code class="docutils literal notranslate"><span class="pre">rose_ana_</span></code> will be interpreted by Rose as a Rose Ana
task, and run through the <a class="reference internal" href="../../../api/built-in/rose_ana.html#rose:app:rose_ana" title="rose:app:rose_ana"><code class="xref rose rose-app docutils literal notranslate"><span class="pre">rose_ana</span></code></a> built-in application.</p>
<p>A Rose Ana <a class="reference internal" href="../../../api/configuration/application.html#rose:file:rose-app.conf" title="rose:file:rose-app.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-app.conf</span></code></a> file contains a series of blocks;
each one describing a different analysis task to perform. A common
task which Rose Ana is used for is to compare output contained in different
files (e.g. from a new test versus previous output from a control).
The analysis modules which provide these tasks are flexible and able to be
provided by the user; however there is one built-in module inside Rose Ana
itself.</p>
<p>An example based on the built-in <code class="docutils literal notranslate"><span class="pre">grepper</span></code> module:</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[ana:grepper.FilePattern(Compare data from myfile)]</span>
<span class="nv">pattern</span><span class="o">=</span><span class="s">&#39;data value:(\d+)&#39;</span>
<span class="nv">files</span><span class="o">=</span><span class="s">/data/kgo/myfile</span>
     <span class="o">=</span><span class="s">../run.1/myfile</span>
</pre></div>
</div>
<p>This tells Rose Ana to scan the contents of the file <code class="docutils literal notranslate"><span class="pre">../run.1/myfile</span></code>
(which is relative to the Rose Ana task’s work directory) and the contents of
<code class="docutils literal notranslate"><span class="pre">/data/kgo/myfile</span></code> for the specified regular expression. Since the
pattern contains a group (in parentheses) so it is the contents of this
group which will be compared between the two files. The <code class="docutils literal notranslate"><span class="pre">grepper.FilePattern</span></code>
analysis task can optionally be given a “tolerance” option for matching
numeric values, but without it the matching is expected to be exact.
If the pattern or group contents do not match the task will return a failure.</p>
<p>As well as sections defining analysis tasks, Rose Ana apps allow for one
additional section for storing global configuration settings for the app.
Just like the tasks themselves these options and their effects are
dependent on which analysis tasks are used by the app.</p>
<p>Therefore we will here present an example using the built-in <code class="docutils literal notranslate"><span class="pre">grepper</span></code>
class. An app may begin with a section like this:</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[ana:config]</span>
<span class="nv">grepper-report-limit</span><span class="o">=</span><span class="s">5</span>
<span class="nv">skip-if-all-files-missing</span><span class="o">=</span><span class="s">.true.</span>
<span class="nv">threads</span><span class="o">=</span><span class="s">10</span>
</pre></div>
</div>
<p>Each of these modifies the behaviour of <code class="docutils literal notranslate"><span class="pre">grepper</span></code>:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">grepper-report-limit</span></code></dt><dd><p>Suppresses printed output for each analysis task once the
specified number of lines have been printed (in this case 5 lines).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">skip-if-all-files-missing</span></code></dt><dd><p>Causes Rose Ana to skip any <code class="docutils literal notranslate"><span class="pre">grepper</span></code> tasks which compare files
in the case that both files do not exist</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">threads</span></code></dt><dd><p>Causes rose_ana to use multiple threads (10 in this case), split
across the individual analysis tasks. Be aware that any custom
(user provided) analysis task which itself makes use of threading
(e.g. by calling a library using OpenMP) may clash or interfere
with the correct operation of this setting.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any options given to this section may instead be specified in the
<a class="reference internal" href="../../../api/configuration/site-and-user.html#rose:conf:rose.conf[rose-ana]" title="rose:conf:rose.conf[rose-ana]"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose.conf[rose-ana]</span></code></a> section of the user or site configuration.
In the case that the same configuration option appears in both locations
the one contained in the app file will take precedence.</p>
</div>
<p>It is possible to add additional analysis modules to Rose Ana by placing an
appropriately formatted python file in one of the following places (in order
of precedence):</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">ana</span></code> sub-directory of the Rose Ana application.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ana</span></code> sub-directory of the suite.</p></li>
<li><p>Any other directory which is accessible to the process running Rose Ana
and is specified in the <a class="reference internal" href="../../../api/configuration/site-and-user.html#rose:conf:rose.conf[rose-ana]method-path" title="rose:conf:rose.conf[rose-ana]method-path"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose.conf[rose-ana]method-path</span></code></a>
variable.</p></li>
</ol>
<p>The only analysis module provided with Rose is
<a class="reference internal" href="../../../api/built-in/rose_ana.html#module-metomi.rose.apps.ana_builtin.grepper" title="metomi.rose.apps.ana_builtin.grepper"><code class="xref py py-mod docutils literal notranslate"><span class="pre">metomi.rose.apps.ana_builtin.grepper</span></code></a>, it provides the following
analysis tasks and options:</p>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">metomi.rose.apps.ana_builtin.grepper.</span></span><span class="sig-name descname"><span class="pre">SingleCommandStatus</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/metomi/rose/apps/ana_builtin/grepper.html#SingleCommandStatus"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Run a shell command, passing or failing depending on the exit
status of that command.</p>
<dl class="simple">
<dt>Options:</dt><dd><dl class="simple">
<dt>files (optional):</dt><dd><p>A newline-separated list of filenames which may appear
in the command.</p>
</dd>
<dt>command:</dt><dd><p>The command to run; if it contains Python style
format specifiers these will be expanded using the list of
files above (if provided).</p>
</dd>
<dt>kgo_file:</dt><dd><p>If the list of files above was provided gives the
(0-based) index of the file holding the “kgo” or “control”
output for use with the comparisons database (if active).</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">metomi.rose.apps.ana_builtin.grepper.</span></span><span class="sig-name descname"><span class="pre">SingleCommandPattern</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/metomi/rose/apps/ana_builtin/grepper.html#SingleCommandPattern"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Run a single command and then pass/fail depending on the presence of a
particular expression in that command’s standard output.</p>
<dl class="simple">
<dt>Options:</dt><dd><dl class="simple">
<dt>files (optional):</dt><dd><p>Same as previous task. command - same as previous task.</p>
</dd>
<dt>kgo_file:</dt><dd><p>Same as previous task.</p>
</dd>
<dt>pattern:</dt><dd><p>The regular expression to search for in the stdout from the
command.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">metomi.rose.apps.ana_builtin.grepper.</span></span><span class="sig-name descname"><span class="pre">FilePattern</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/metomi/rose/apps/ana_builtin/grepper.html#FilePattern"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Check for occurrences of a particular expression or value within the
contents of two or more files.</p>
<dl class="simple">
<dt>Options:</dt><dd><dl class="simple">
<dt>files (optional):</dt><dd><p>Same as previous tasks.</p>
</dd>
<dt>kgo_file:</dt><dd><p>Same as previous tasks.</p>
</dd>
<dt>pattern:</dt><dd><p>The regular expression to search for in the files. The
expression should include one or more capture groups; each
of these will be compared between the files any time the
pattern occurs.</p>
</dd>
<dt>tolerance (optional):</dt><dd><p>By default the above comparisons will be compared exactly,
but if this argument is specified they will be converted to
float values and compared according to the given tolerance.
If this tolerance ends in % it will be interpreted as a
relative tolerance (otherwise absolute).</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">metomi.rose.apps.ana_builtin.grepper.</span></span><span class="sig-name descname"><span class="pre">FileCommandPattern</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/metomi/rose/apps/ana_builtin/grepper.html#FileCommandPattern"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Check for occurrences of a particular expression or value in the
standard output from a command applied to two or more files.</p>
<dl class="simple">
<dt>Options:</dt><dd><dl class="simple">
<dt>files (optional):</dt><dd><p>Same as previous tasks.</p>
</dd>
<dt>kgo_file:</dt><dd><p>Same as previous tasks.</p>
</dd>
<dt>pattern:</dt><dd><p>Same as previous tasks.</p>
</dd>
<dt>tolerance (optional):</dt><dd><p>Same as previous tasks.</p>
</dd>
<dt>command:</dt><dd><p>The command to run; it should contain a Python style format
specifier to be expanded using the list of files above.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p>The following options can be specified in:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api/configuration/site-and-user.html#rose:conf:rose.conf[rose-ana]" title="rose:conf:rose.conf[rose-ana]"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose.conf[rose-ana]</span></code></a></p></li>
<li><p><a class="reference internal" href="../../../api/built-in/rose_ana.html#rose:conf:rose_ana[ana:config]" title="rose:conf:rose_ana[ana:config]"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose_ana[ana:config]</span></code></a></p></li>
</ul>
<dl class="describe">
<dt class="sig sig-object">
<span class="sig-name descname"><span class="pre">Options</span></span></dt>
<dd><dl class="simple">
<dt>grepper-report-limit:</dt><dd><p>A numerical value giving the maximum number of informational output
lines to print for each comparison. This is intended for cases where
for example a pattern-matching comparison is expected to match many
thousands of occurrences in the given files; it may not be desirable
to print the results of every comparison. After the given number of
lines are printed a special message indicating that the rest of the
output is truncated will be produced.</p>
</dd>
<dt>skip-if-all-files-missing:</dt><dd><p>Can be set to <code class="docutils literal notranslate"><span class="pre">.true.</span></code> or <code class="docutils literal notranslate"><span class="pre">.false.</span></code>; if active, any comparison
done on files by <code class="docutils literal notranslate"><span class="pre">grepper</span></code> will be skipped if all of those files
are non-existent. In this case the task will return as “skipped”
rather than passed/failed.</p>
</dd>
</dl>
</dd></dl>

<p>The format for analysis modules themselves is relatively simple; the easiest
route to understanding how they should be arranged is likely to look at the
built-in <code class="docutils literal notranslate"><span class="pre">grepper</span></code> module. But the key concepts are as follows. To be
recognised as a valid analysis module, the Python file must contain at
least one class which inherits and extends
<a class="reference internal" href="#metomi.rose.apps.rose_ana.AnalysisTask" title="metomi.rose.apps.rose_ana.AnalysisTask"><code class="xref py py-mod docutils literal notranslate"><span class="pre">metomi.rose.apps.rose_ana.AnalysisTask</span></code></a>:</p>
<dl class="py class">
<dt class="sig sig-object py" id="metomi.rose.apps.rose_ana.AnalysisTask">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">metomi.rose.apps.rose_ana.</span></span><span class="sig-name descname"><span class="pre">AnalysisTask</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parent_app</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_options</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/metomi/rose/apps/rose_ana.html#AnalysisTask"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#metomi.rose.apps.rose_ana.AnalysisTask" title="Link to this definition"></a></dt>
<dd><p>Base class for an analysis task.</p>
<p>All custom user tasks should inherit from this class and override
the <code class="docutils literal notranslate"><span class="pre">run_analysis</span></code> method to perform whatever analysis is required.</p>
<p>This class provides the following attributes:</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="metomi.rose.apps.rose_ana.AnalysisTask.self.config">
<span class="sig-prename descclassname"><span class="pre">self.</span></span><span class="sig-name descname"><span class="pre">config</span></span><a class="headerlink" href="#metomi.rose.apps.rose_ana.AnalysisTask.self.config" title="Link to this definition"></a></dt>
<dd><p>A dictionary containing any Rose Ana configuration options.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="metomi.rose.apps.rose_ana.AnalysisTask.self.reporter">
<span class="sig-prename descclassname"><span class="pre">self.</span></span><span class="sig-name descname"><span class="pre">reporter</span></span><a class="headerlink" href="#metomi.rose.apps.rose_ana.AnalysisTask.self.reporter" title="Link to this definition"></a></dt>
<dd><p>A reference to the <a class="reference internal" href="../../../api/other.html#metomi.rose.reporter.Reporter" title="metomi.rose.reporter.Reporter"><code class="xref py py-class docutils literal notranslate"><span class="pre">metomi.rose.reporter.Reporter</span></code></a>
instance used by the parent app (for printing to stderr/stdout).</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="metomi.rose.apps.rose_ana.AnalysisTask.self.kgo_db">
<span class="sig-prename descclassname"><span class="pre">self.</span></span><span class="sig-name descname"><span class="pre">kgo_db</span></span><a class="headerlink" href="#metomi.rose.apps.rose_ana.AnalysisTask.self.kgo_db" title="Link to this definition"></a></dt>
<dd><p>A reference to the KGO database object created by the parent app
(for adding entries to the database).</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="metomi.rose.apps.rose_ana.AnalysisTask.self.popen">
<span class="sig-prename descclassname"><span class="pre">self.</span></span><span class="sig-name descname"><span class="pre">popen</span></span><a class="headerlink" href="#metomi.rose.apps.rose_ana.AnalysisTask.self.popen" title="Link to this definition"></a></dt>
<dd><p>A reference to the <a class="reference internal" href="../../../api/other.html#metomi.rose.popen.RosePopener" title="metomi.rose.popen.RosePopener"><code class="xref py py-class docutils literal notranslate"><span class="pre">metomi.rose.popen.RosePopener</span></code></a>
instance used by the parent app (for spawning subprocesses).</p>
</dd></dl>

</dd></dl>

<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">metomi.rose.apps.rose_ana</span> <span class="kn">import</span> <span class="n">AnalysisTask</span>

<span class="k">class</span> <span class="nc">CustomAnalysisTask</span><span class="p">(</span><span class="n">AnalysisTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;My new custom analysis task.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">run_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>  <span class="c1"># Dictionary of options (see next slide)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;option1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Assuming the above was saved in a file called <code class="docutils literal notranslate"><span class="pre">custom.py</span></code> and placed
into a folder suitable for analysis modules this would allow a Rose Ana
application to specify:</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[ana:custom.CustomAnalysisTask(Example rose-ana test)]</span>
<span class="nv">option1 </span><span class="o">=</span> <span class="s">5</span>
<span class="nv">option2 </span><span class="o">=</span> <span class="s">test of Rose Ana</span>
<span class="nv">option3 </span><span class="o">=</span> <span class="s">.true.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The custom part of the filename appears at the start of the
<code class="docutils literal notranslate"><span class="pre">ana</span></code> entry, followed by the name of the desired class (in the style
of Python’s own namespacing). All options specified by the app-task
will be processed by Rose Ana into a dictionary and attached to the
running analysis class instance as the options attribute. Hopefully you
can see that in this case the task would pass because <code class="docutils literal notranslate"><span class="pre">option1</span></code> is set
to 5 as required by the class.</p>
</div>
</section>
<section id="the-rose-ana-comparison-database">
<span id="id3"></span><h2>The Rose Ana Comparison Database<a class="headerlink" href="#the-rose-ana-comparison-database" title="Link to this heading"></a></h2>
<p>In addition to performing the comparisons each of the Rose Ana tasks in the
suite can be configured to append some key details about any comparisons
performed to an sqlite database kept in the suite’s log directory (at
<code class="docutils literal notranslate"><span class="pre">log/rose-ana-comparisons.db</span></code>).</p>
<p>This is intended to provide a quick means to interrogate the suite for
information about the status of any comparisons it has performed. There are
2 tables present in the suite which contain the following:</p>
<dl>
<dt>tasks (TABLE)</dt><dd><p>The intention of this table is to detect if any Rose Ana tasks have
failed unexpectedly (or are still running).</p>
<p>Contains an entry for each Rose Ana task, using the following columns:</p>
<dl>
<dt>task_name (TEXT)</dt><dd><p>The exact name of the Rose Ana task.</p>
</dd>
<dt>completed (INT)</dt><dd><p>Set to 1 when the task starts performing its comparisons then updated
to 0 when the task has completed</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Task success is not related to the success/failed state of the
comparisons).</p>
</div>
</dd>
</dl>
</dd>
<dt>comparisons (TABLE)</dt><dd><p>The intention of this table is to provide a record of which files
were compared by which tasks, how they were compared and what the
result of the comparison was.</p>
<p>Contains an entry for each individual comparison from every
Rose Ana task, using the following columns:</p>
<dl class="simple">
<dt>comp_task (TEXT)</dt><dd><p>The comparison task name - by convention this is usually the
comparison section name from the app definition (including the
part inside the brackets).</p>
</dd>
<dt>kgo_file (TEXT)</dt><dd><p>The full path to the file specified as the KGO file in
the app definition.</p>
</dd>
<dt>suite_file (TEXT)</dt><dd><p>The full path to the file specified as the
active test output in the app definition.</p>
</dd>
<dt>status (TEXT)</dt><dd><p>The status of the task (one of “ OK “, “FAIL” or “WARN”).
comparison (TEXT) Additional details which may be provided
about the comparison.</p>
</dd>
</dl>
</dd>
</dl>
<p>The database is entirely optional; by default is will not be produced; if
it is required it can be activated by setting
<a class="reference internal" href="../../../api/configuration/site-and-user.html#rose:conf:rose.conf[rose-ana]kgo-database" title="rose:conf:rose.conf[rose-ana]kgo-database"><code class="xref rose rose-conf docutils literal notranslate"><span class="pre">rose.conf[rose-ana]kgo-database=.true.</span></code></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The system does not provide any direct methods for working with or
interrogating the database - since there could be various reasons for
doing so, and there may be other suite-design factors to consider.
Users are therefore expected to provide this functionality separately
based on their specific needs.</p>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>From within a working copy, running <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">stem</span></code> is simple. Just run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">stem</span> <span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">groupname</span>
</pre></div>
</div>
<p>replacing the groupname with the desired task. Rose Stem should then
automatically pick up the working copy and run the requested tests on it.</p>
<p>Next see the <a class="reference internal" href="rose-stem-tutorial.html#rose-stem-tutorial"><span class="std std-ref">Rose Stem Tutorial</span></a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="rose-bunch.html" class="btn btn-neutral float-left" title="Rose Bunch" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rose-stem-tutorial.html" class="btn btn-neutral float-right" title="Rose Stem Tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright : Copyright (C) British Crown (Met Office) &amp; Contributors. See Terms of Use. This document is released under the Open Government Licence.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note"
     aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Read the Docs</span>
    v: 2.4.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions" id="version-selector">
    <script type="text/javascript">
        // NOTE: temporary variables not initiated so that they can be deleted

        // path to a root file in the current version of the documentation
        version_path = "../../../.html".split('/');
        // dirname of the root dir
        version_dir = version_path
            .splice(0, version_path.length - 1)
            .join('/');
        delete version_path;
        // relative path from the current version to the documentation root
        rel_path = '../../';
        // relative path from the current document to the documentation root
        var root_dir;
        if (version_dir) {
            root_dir = version_dir + '/' + rel_path;
        } else {
            root_dir = rel_path;
        }
        delete version_dir;
        delete rel_path;
        // the name of the current version of the documentation
        const current_version = "2.4.0";
        // the name of the builder (i.e. html)
        const current_builder = "html";
        // the name of the current page
        const current_page_name = "tutorial/rose/furthertopics/rose-stem";
    </script>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  
<style>
/* make sidebar header off-white. NB: only very light colours work given image
   edge transparency issues, but white itself clashes with the main pages.  */
.wy-side-nav-search, .wy-nav-top {
    background: #f9f9eb;
}
/* make sidebar header version text the dark blue of the Rose logo */
.wy-side-nav-search div.version {
    color: #2B2663;
}
</style>


</body>
</html>