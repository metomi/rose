

<!DOCTYPE html>


<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Custom Macros &mdash; Rose Documentation 2.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/styles.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/single.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <link rel="stylesheet" href="../../../_static/css/slides-custom.css" type="text/css" />
    
    
    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/single.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/diff_selector.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/grid_table.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/hieroglyph_theme_addons.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/tutorial.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/addons.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/diff_selector.js"></script>
    <script type="text/javascript" src="../../../_static/js/minicylc.js"></script>
    <script type="text/javascript" src="../../../_static/js/spoiler.js"></script>
    <script type="text/javascript" src="../../../_static/js/addons.js"></script>
    <script type="text/javascript" src="../../../_static/js/versioning.js"></script>
    <script type="text/javascript" src="../../../_static/common.js"></script>
    
    <script type="text/javascript" src="../../../_static/slides.js"></script>
    <script type="text/javascript" src="../../../_static/sync.js"></script>
    <script type="text/javascript" src="../../../_static/controller.js"></script>
    <script type="text/javascript" src="../../../_static/init.js"></script>
    
    
    <link rel="shortcut icon" href="../../../_static/rose-favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="top" title="Rose Documentation 2.0.0 documentation" href="../../../index.html" />
    <link rel="up" title="Further Topics" href="index.html" />
    <link rel="next" title="Optional Configurations" href="optional-configurations.html" />
    <link rel="prev" title="Fail-If, Warn-If" href="failif-warnif.html" /> 
  </head>
  <body>

<section
   id="slide_container"
   class='slides layout-regular'>


  
<article class="slide level-1" id="custom-macros">

<h1>Custom Macros<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#custom-macros" title="View HTML">§</a></h1>

<p>Rose macros are custom python modules which can perform checking
beyond that which (e.g. <code class="docutils literal notranslate"><span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">range</span></code>, <code class="docutils literal notranslate"><span class="pre">warn-if</span></code>, etc)
can provide.</p>
<p>This tutorial covers the development of checking (<strong>validator</strong>),
changing (<strong>transformer</strong>) and reporting (<strong>reporter</strong>) macros.</p>




</article>
<article class="slide level-2" id="warning">

<h2>Warning<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#warning" title="View HTML">§</a></h2>

<p>Macros should <strong>only</strong> be written if there is a genuine need that is not
covered by <a class="reference internal" href="../../../api/configuration/metadata.html#metadata-values"><span class="std std-ref">other metadata</span></a> - make sure you are
familiar with <a class="reference internal" href="../../../api/configuration/metadata.html#conf-meta"><span class="std std-ref">Configuration Metadata</span></a> before you write your own (real-life)
macros.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">fail-if</span></code> and <code class="docutils literal notranslate"><span class="pre">warn-if</span></code> metadata options can perform
complex inter-setting validation. See the
<a class="reference internal" href="failif-warnif.html#tutorial-rose-fail-if-warn-if"><span class="std std-ref">tutorial</span></a> for details.</p>




</article>
<article class="slide level-2" id="purpose">

<h2>Purpose<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#purpose" title="View HTML">§</a></h2>

<p>Macros are used in Rose to report problems with a configuration,
and to change it. Nearly all metadata mechanics (checking vs metadata
settings, and changing - e.g. <code class="docutils literal notranslate"><span class="pre">trigger</span></code>) are performed within Rose
by the Rose built-in macros.</p>
<p>Custom macros are user-defined, but follow exactly the same API - they
are just in a different filespace location. They can be invoked via
the command line (<a class="reference internal" href="../../../api/command-reference.html#command-rose-macro"><span class="std std-ref">rose macro</span></a>) or from within the
<span class="menuselection">Metadata</span> menu in the config editor.</p>




</article>
<article class="slide level-2" id="example">

<h2>Example<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#example" title="View HTML">§</a></h2>

<p>For these examples we will create an example app called
<code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code> that could be part of a typical suite.</p>
<p>Create a directory for your suite app called <code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">~/</span><span class="n">rose</span><span class="o">-</span><span class="n">tutorial</span><span class="o">/</span><span class="n">macro_tutorial_app</span>
</pre></div>
</div>
<p>Inside the <code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code> directory, create a <a class="reference internal" href="../../../api/configuration/application.html#rose:file:rose-app.conf" title="rose:file:rose-app.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-app.conf</span></code></a>
file and paste in the following contents:</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[command]</span>
<span class="nv">default</span><span class="o">=</span><span class="s">echo &quot;Hello $WORLD!&quot;</span>

<span class="nt">[env]</span>
<span class="nv">WORLD</span><span class="o">=</span><span class="s">Earth</span>
</pre></div>
</div>
<p>The metadata for the app lives under the <code class="docutils literal notranslate"><span class="pre">meta/</span></code> sub directory.
Our new macro will live with the metadata.</p>
<p>For this example, we want to check the value of the option
<code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> in our <code class="docutils literal notranslate"><span class="pre">macro_tutorial_app</span></code> application. Specifically,
for this example, we want our macro to give us an error if the ‘world’
is too far away from Earth.</p>
<p>Create the directories <code class="docutils literal notranslate"><span class="pre">meta/lib/python/macros/</span></code> by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">meta</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">macros</span>
</pre></div>
</div>
<p>Create an empty file called <a class="reference internal" href="../../../api/configuration/metadata.html#rose:file:rose-meta.conf" title="rose:file:rose-meta.conf"><code class="xref rose rose-file docutils literal notranslate"><span class="pre">rose-meta.conf</span></code></a> in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">meta</span><span class="o">/</span><span class="n">rose</span><span class="o">-</span><span class="n">meta</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Create an empty file called <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">meta</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Finally, create a file called <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> in the directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">meta</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">macros</span><span class="o">/</span><span class="n">planet</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>




</article>
<article class="slide level-3" id="validator-macro">

<h3>Results<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#results" title="View HTML">§</a></h3>

<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> in a text editor and paste in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Rose validator macro for &quot;planet&quot;.</span>

<span class="sd">Designed to be compatible with both Python 2 and 3 so that the Rose 2 macro</span>
<span class="sd">command will work, and so will the Rose 1 GUI.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">metomi.rose.macro</span> <span class="kn">import</span> <span class="n">MacroBase</span>
    <span class="n">PY_3</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">rose.macro</span> <span class="kn">import</span> <span class="n">MacroBase</span>
    <span class="n">PY_3</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">PlanetChecker</span><span class="p">(</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks option values that refer to planets.&quot;&quot;&quot;</span>

    <span class="n">opts_to_check</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_check</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="c1"># Check the option value (node.value) here</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>This is the bare bones of a Rose macro - a bit of Python that is a
subclass of <a class="reference internal" href="../../../api/rose-macro.html#metomi.rose.macro.MacroBase" title="metomi.rose.macro.MacroBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">metomi.rose.macro.MacroBase</span></code></a>. At the moment, it doesn’t
do anything.</p>
<p>We need to check the value of the option (<code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code>) in our
app configuration. To do this, we’ll generate a list of allowed
‘planet’ choices that aren’t too far away from Earth at the moment.</p>
<p>Call a method to get the choices by adding the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
</pre></div>
</div>
<p>at the top of the <code class="docutils literal notranslate"><span class="pre">validate</span></code> method, so it looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
    <span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
</pre></div>
</div>
<p>Now add the method <code class="docutils literal notranslate"><span class="pre">_get_allowed_planets</span></code> to the class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_get_allowed_planets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Retrieve planets less than a certain distance away.</span>
    <span class="n">cmd_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;http://www.heavens-above.com/planetsummary.aspx&quot;</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_strings</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">PY_3</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                         <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(tablehead.*?ascension).*$&#39;</span><span class="p">,</span>
                                <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;([\d.]+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                           <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(Range.*?Brightness).*$&#39;</span><span class="p">,</span>
                                  <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">planet</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">planets</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="c1"># The planet is more than 5 AU away.</span>
            <span class="n">planets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
    <span class="n">planets</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Earth&quot;</span><span class="p">]</span>  <span class="c1"># Distance ~ 0</span>
    <span class="k">return</span> <span class="n">planets</span>
</pre></div>
</div>
<p>This will give us a list of valid (nearby) solar system planets which
our configuration option should be in. If it isn’t, we need to send a
message explaining the problem. Add:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">error_text</span> <span class="o">=</span> <span class="s2">&quot;planet is too far away.&quot;</span>
</pre></div>
</div>
<p>at the top of the class, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChecker</span><span class="p">(</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks option values that refer to planets.&quot;&quot;&quot;</span>

    <span class="n">error_text</span> <span class="o">=</span> <span class="s2">&quot;planet is too far away.&quot;</span>
    <span class="n">opts_to_check</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
        <span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, we need to check if the configuration option is in the list,
by replacing</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the option value (node.value) here</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_planets</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_text</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">self.add_report</span></code> call is invoked when the planet choice the
user has made is not in the allowed planets. It adds the error
information about the section and option (<code class="docutils literal notranslate"><span class="pre">env</span></code> and <code class="docutils literal notranslate"><span class="pre">WORLD</span></code>)
to the <code class="docutils literal notranslate"><span class="pre">self.reports</span></code> list, which is returned to the rest of
Rose to see if the macro reports any problems.</p>
<p>Your final macro should look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Rose validator macro for &quot;planet&quot;.</span>

<span class="sd">Designed to be compatible with both Python 2 and 3 so that the Rose 2 macro</span>
<span class="sd">command will work, and so will the 2019 GUI.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">metomi.rose.macro</span> <span class="kn">import</span> <span class="n">MacroBase</span>
    <span class="n">PY_3</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">rose.macro</span> <span class="kn">import</span> <span class="n">MacroBase</span>
    <span class="n">PY_3</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">PlanetChecker</span><span class="p">(</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks option values that refer to planets.&quot;&quot;&quot;</span>

    <span class="n">error_text</span> <span class="o">=</span> <span class="s2">&quot;planet is too far away.&quot;</span>
    <span class="n">opts_to_check</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of errors, if any.&quot;&quot;&quot;</span>
        <span class="n">allowed_planets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_planets</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_check</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_planets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>

    <span class="k">def</span> <span class="nf">_get_allowed_planets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Retrieve planets less than a certain distance away.</span>
        <span class="n">cmd_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;http://www.heavens-above.com/planetsummary.aspx&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_strings</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PY_3</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">planets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                             <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?s)^.*(&lt;thead.*?ascension).*$&#39;</span><span class="p">,</span>
                                    <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;([\d.]+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                               <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(Range.*?Brightness).*$&#39;</span><span class="p">,</span>
                                      <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">planet</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">planets</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="c1"># The planet is more than 5 AU away.</span>
                <span class="n">planets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
        <span class="n">planets</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;Earth&quot;</span><span class="p">]</span>  <span class="c1"># Distance ~ 0</span>
        <span class="k">return</span> <span class="n">planets</span>
</pre></div>
</div>
<div class="section level-4" id="results">
<p>Your validator macro is now ready to use.</p>
<p>Modify the top level <code class="docutils literal notranslate"><span class="pre">rose-app.conf</span></code> such that <code class="docutils literal notranslate"><span class="pre">WORLD=Jupiter</span></code>.</p>
<p>Run your macro from the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">macro</span> <span class="n">planet</span><span class="o">.</span><span class="n">PlanetChecker</span>
</pre></div>
</div>
<p>Try changing the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to other solar system planets
and re-running the macro.</p>
</div>



</article>
<article class="slide level-3" id="transformer-macro">

<h3>Transformer Macro<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#transformer-macro" title="View HTML">§</a></h3>

<p>We’ll now make a macro that changes the configuration. Our example
will change the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to something else.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> in a text editor and append the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChanger</span><span class="p">(</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Switch between planets.&quot;&quot;&quot;</span>

    <span class="n">change_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> to </span><span class="si">{1}</span><span class="s1">&#39;</span>
    <span class="n">opts_to_change</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mercury&quot;</span><span class="p">,</span> <span class="s2">&quot;Venus&quot;</span><span class="p">,</span> <span class="s2">&quot;Earth&quot;</span><span class="p">,</span> <span class="s2">&quot;Mars&quot;</span><span class="p">,</span> <span class="s2">&quot;Jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Uranus&quot;</span><span class="p">,</span> <span class="s2">&quot;Neptune&quot;</span><span class="p">,</span> <span class="s2">&quot;Eris&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform configuration and return it with a list of changes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_change</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="c1"># Do something to the configuration.</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>This is another bare-bones macro class, although this time it supplies
a <code class="docutils literal notranslate"><span class="pre">transform</span></code> method instead of a <code class="docutils literal notranslate"><span class="pre">validate</span></code> method.</p>
<p>You can see that it returns a configuration object (<code class="docutils literal notranslate"><span class="pre">config</span></code>) as well
as <code class="docutils literal notranslate"><span class="pre">self.reports</span></code>. This means that you can modify the configuration
e.g. by adding or deleting a variable and then returning the changed
config object.</p>
<p>We need to add some code to make some changes to the configuration.</p>
<p>Replace the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do something to the configuration.</span>
</pre></div>
</div>
<p>with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
    <span class="k">continue</span>
<span class="n">old_planet</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_planet</span><span class="p">)</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">)]</span>
<span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
</pre></div>
</div>
<p>This changes the option <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code> to the next planet on the list.
It will set it to the first planet on the list if it is something else.
It will skip it if it is missing or ignored.</p>
<p>We also need to add a change message to flag what we’ve changed.</p>
<p>Beneath the line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
</pre></div>
</div>
<p>add the following two lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_planet</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
<p>This makes use of the template <code class="docutils literal notranslate"><span class="pre">self.change_text</span></code> at the top of
the class. The message will be used to provide more information to
the user about the change.</p>
<p>Your class should now look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChanger</span><span class="p">(</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Switch between planets.&quot;&quot;&quot;</span>

    <span class="n">change_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> to </span><span class="si">{1}</span><span class="s1">&#39;</span>
    <span class="n">opts_to_change</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mercury&quot;</span><span class="p">,</span> <span class="s2">&quot;Venus&quot;</span><span class="p">,</span> <span class="s2">&quot;Earth&quot;</span><span class="p">,</span> <span class="s2">&quot;Mars&quot;</span><span class="p">,</span> <span class="s2">&quot;Jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturn&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Uranus&quot;</span><span class="p">,</span> <span class="s2">&quot;Neptune&quot;</span><span class="p">,</span> <span class="s2">&quot;Eris&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform configuration and return it with a list of changes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_change</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">old_planet</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_planet</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">)]</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_planet</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>Your transform macro is now ready to use.</p>
<p>You can run your macro from the command line in the application
directory by invoking <code class="docutils literal notranslate"><span class="pre">rose</span> <span class="pre">macro</span> <span class="pre">planet.PlanetChanger</span></code>.</p>




</article>
<article class="slide level-3" id="reporter-macro">

<h3>Reporter Macro<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#reporter-macro" title="View HTML">§</a></h3>

<p>Along with validator and transformer macros there are also reporter
macros. These are used when you want to output information about a
configuration but do not want to make any changes to it.</p>
<p>Next we will write a reporter macro which produces a horoscope
entry based on the value of <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code>.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> and paste in this text:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetReporter</span><span class="p">(</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Creates a report on the value of env=WORLD.&quot;&quot;&quot;</span>

    <span class="n">GENERIC_HOROSCOPE_STATEMENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;be cautious&#39;</span><span class="p">,</span> <span class="s1">&#39;remain indoors&#39;</span><span class="p">,</span> <span class="s1">&#39;expect the unexpected&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not walk under ladders&#39;</span><span class="p">,</span> <span class="s1">&#39;seek new opportunities&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">world_node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">world_node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">world_node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">planet</span> <span class="o">=</span> <span class="n">world_node</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">planet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;earth&#39;</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Please choose a planet other than Earth.&#39;</span>
            <span class="k">return</span>
        <span class="n">constellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_planet_info</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">constellation</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;Could not find horoscope entry for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{planet}</span><span class="s1"> is currently passing through </span><span class="si">{constellation}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;You should </span><span class="si">{generic_message}</span><span class="s1"> today.&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">planet</span> <span class="o">=</span> <span class="n">planet</span><span class="p">,</span>
                <span class="n">constellation</span> <span class="o">=</span> <span class="n">constellation</span><span class="p">,</span>
                <span class="n">generic_message</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">GENERIC_HOROSCOPE_STATEMENTS</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_planet_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">planet_name</span><span class="p">):</span>
        <span class="n">cmd_strings</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;http://www.heavens-above.com/planetsummary.aspx&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_strings</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PY_3</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">planets</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/td&gt;&quot;</span><span class="p">,</span>
                             <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?s)^.*(&lt;thead.*?ascension).*$&#39;</span><span class="p">,</span>
                                    <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="n">constellations</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;(\w+)&lt;/a&gt;&quot;</span><span class="p">,</span>
                               <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;(?s)^.*(Constellation.*?Meridian).*$&#39;</span><span class="p">,</span>
                                      <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">planet</span><span class="p">,</span> <span class="n">constellation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">planets</span><span class="p">,</span> <span class="n">constellations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">planet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">planet_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">constellation</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>You will need to add the following line with the other imports at the
top of the file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
<p>Next run this macro from the command line by invoking:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rose</span> <span class="n">macro</span> <span class="n">planet</span><span class="o">.</span><span class="n">PlanetReporter</span>
</pre></div>
</div>




</article>
<article class="slide level-2" id="macro-arguments">

<h2>Macro Arguments<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#macro-arguments" title="View HTML">§</a></h2>

<p>From time to time, we may want to change some macro settings.
Rather than altering the macro each time or creating a separate
macro for every possible setting, we can make use of Python keyword
arguments.</p>
<p>We will alter the transformer macro to allow us to specify the name
of the planet we want to use.</p>
<p>Open <code class="docutils literal notranslate"><span class="pre">planet.py</span></code> and alter the <code class="docutils literal notranslate"><span class="pre">PlanetChanger</span></code> class to look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PlanetChanger</span><span class="p">(</span><span class="n">rose</span><span class="o">.</span><span class="n">macro</span><span class="o">.</span><span class="n">MacroBase</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Switch between planets.&quot;&quot;&quot;</span>

    <span class="n">change_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> to </span><span class="si">{1}</span><span class="s1">&#39;</span>
    <span class="n">opts_to_change</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;env&quot;</span><span class="p">,</span> <span class="s2">&quot;WORLD&quot;</span><span class="p">)]</span>
    <span class="n">planets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mercury&quot;</span><span class="p">,</span> <span class="s2">&quot;Venus&quot;</span><span class="p">,</span> <span class="s2">&quot;Earth&quot;</span><span class="p">,</span> <span class="s2">&quot;Mars&quot;</span><span class="p">,</span> <span class="s2">&quot;Jupiter&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturn&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Uranus&quot;</span><span class="p">,</span> <span class="s2">&quot;Neptune&quot;</span><span class="p">,</span> <span class="s2">&quot;Eris&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">meta_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">planet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform configuration and return it with a list of changes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts_to_change</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">is_ignored</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">old_planet</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">planet_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">old_planet</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_planet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planets</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_planet</span> <span class="o">=</span> <span class="n">planet_name</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">],</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_text</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_planet</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_report</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">new_planet</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span>
</pre></div>
</div>
<p>This adds the <code class="docutils literal notranslate"><span class="pre">planet_name</span></code> argument to the transform method with
a default value of <code class="docutils literal notranslate"><span class="pre">None</span></code>. On running the macro it will give you
the option to specify a value for <code class="docutils literal notranslate"><span class="pre">planet_name</span></code>. If you do, then
that will be used as the new planet.</p>
<p>Save your changes and run the transformer macro either from the
command line or <a class="reference internal" href="../../../api/command-reference.html#command-rose-config-edit"><span class="std std-ref">rose config-edit</span></a>. You should be prompted to
provide a value for <code class="docutils literal notranslate"><span class="pre">planet_name</span></code>. At the command line this will take the
form of a prompt while in <a class="reference internal" href="../../../api/command-reference.html#command-rose-config-edit"><span class="std std-ref">rose config-edit</span></a> you will be presented
with a dialog to enter values in, with defaults already entered for you.</p>
<p>Specify a value to use for <code class="docutils literal notranslate"><span class="pre">planet_name</span></code> using a quoted string,
e.g. <code class="docutils literal notranslate"><span class="pre">&quot;Vulcan&quot;</span></code> and accept the proposed changes. The <code class="docutils literal notranslate"><span class="pre">WORLD</span></code>
variable should now be set to <code class="docutils literal notranslate"><span class="pre">Vulcan</span></code>. Check your configuration
to confirm this.</p>




</article>
<article class="slide level-2" id="metadata-option">

<h2>Metadata Option<a class="headerlink" href="../../../../html/tutorial/rose/furthertopics/macro-development.html#metadata-option" title="View HTML">§</a></h2>

<p>If a macro addresses particular sections, namespaces, or options,
then it makes sense to write the relationship down in the metadata
for the particular settings. You can do this using the <code class="docutils literal notranslate"><span class="pre">macro</span></code>
metadata option.</p>
<p>For example, our validator and transformer macros above are both
specific to <code class="docutils literal notranslate"><span class="pre">env=WORLD</span></code>. Open the file
<code class="docutils literal notranslate"><span class="pre">macro_tutorial_app/meta/rose-meta.conf</span></code> in a text editor, and
add the following lines</p>
<div class="highlight-rose notranslate"><div class="highlight"><pre><span></span><span class="nt">[env=WORLD]</span>
<span class="nv">macro</span><span class="o">=</span><span class="s">planet.PlanetChecker, planet.PlanetChanger</span>
</pre></div>
</div>
<p>Close the config editor if it is still open, and open the app in the
config editor again. The env page should now contain a dropdown menu
at the top of the page for launching the two macros.</p>




</article>

</section>

<section id="slide_notes">

</section>

  </body>
</html>